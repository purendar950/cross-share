<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>CrossConnect ‚Äî Works Right in Your Browser</title>
<meta name="description" content="Share files, clipboard, screen between devices. No install. No server. Free."/>
<!-- PWA Manifest ‚Äî generates proper icon so Android shows real install prompt -->
<link rel="manifest" id="pwaManifest"/>
<meta name="theme-color" content="#00e5ff"/>
<meta name="mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<link rel="apple-touch-icon" id="appleIcon"/>

<!-- PeerJS ‚Äî handles ALL WebRTC + signaling via free cloud server. No backend needed! -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500;600;700&family=Outfit:wght@300;400;600;700;800;900&display=swap" rel="stylesheet"/>

<style>
:root{
  --bg:#060810;--s1:#0b0f1a;--s2:#111827;--s3:#1a2235;
  --b1:#1e2d45;--b2:#2a3f5f;
  --cyan:#00e5ff;--violet:#8b5cf6;--emerald:#10b981;
  --amber:#f59e0b;--rose:#f43f5e;
  --t1:#f0f6ff;--t2:#8899bb;--t3:#c5d3e8;
  --glow-c:0 0 24px rgba(0,229,255,.3);
  --glow-v:0 0 24px rgba(139,92,246,.3);
  --r:12px;--rs:7px;
}
*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;}
body{
  background:var(--bg);color:var(--t1);
  font-family:'Outfit',sans-serif;
  overflow:hidden;
  background-image:
    radial-gradient(ellipse 60% 40% at 10% 10%,rgba(0,229,255,.05) 0%,transparent 60%),
    radial-gradient(ellipse 50% 40% at 90% 90%,rgba(139,92,246,.06) 0%,transparent 60%);
}

/* ‚ïê‚ïê‚ïê LAYOUT ‚ïê‚ïê‚ïê */
.app{display:grid;grid-template-columns:220px 1fr;grid-template-rows:58px 1fr;height:100vh;}

/* ‚ïê‚ïê‚ïê TOPBAR ‚ïê‚ïê‚ïê */
.topbar{
  grid-column:1/-1;
  display:flex;align-items:center;justify-content:space-between;
  padding:0 20px;
  border-bottom:1px solid var(--b1);
  background:rgba(6,8,16,.9);backdrop-filter:blur(24px);
  position:relative;z-index:50;
}
.logo{display:flex;align-items:center;gap:9px;font-size:1rem;font-weight:800;letter-spacing:-.3px;}
.logo-mark{
  width:30px;height:30px;
  background:conic-gradient(from 135deg,var(--cyan),var(--violet),var(--cyan));
  border-radius:8px;display:grid;place-items:center;
  font-size:14px;animation:spin 8s linear infinite;
}
@keyframes spin{to{filter:hue-rotate(360deg);}}
.logo span{color:var(--cyan);}
.topbar-mid{display:flex;align-items:center;gap:10px;}
.conn-badge{
  display:flex;align-items:center;gap:7px;
  padding:5px 14px;border-radius:100px;
  background:var(--s2);border:1px solid var(--b1);
  font-family:'IBM Plex Mono',monospace;font-size:.72rem;
  color:var(--t2);cursor:pointer;transition:all .2s;
}
.conn-badge:hover{border-color:var(--cyan);}
.led{width:7px;height:7px;border-radius:50%;background:var(--t2);transition:all .3s;}
.led.on{background:var(--emerald);box-shadow:0 0 8px var(--emerald);animation:blink 2s infinite;}
.led.busy{background:var(--amber);animation:blink .5s infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.4}}
.topbar-right{display:flex;align-items:center;gap:8px;}
.topbar-room{
  display:flex;align-items:center;gap:0;
  border:1.5px solid rgba(0,229,255,.35);border-radius:100px;
  background:linear-gradient(135deg,rgba(0,229,255,.07),rgba(139,92,246,.07));
  overflow:hidden;transition:border-color .2s;
}
.topbar-room:focus-within{border-color:var(--cyan);box-shadow:0 0 18px rgba(0,229,255,.2);}
.topbar-room-label{
  padding:0 10px 0 14px;
  font-size:.58rem;color:var(--t2);font-family:'IBM Plex Mono',monospace;
  text-transform:uppercase;letter-spacing:1.5px;white-space:nowrap;
  border-right:1px solid rgba(0,229,255,.2);
}
.topbar-room-inp{
  width:110px;padding:7px 10px;
  background:transparent;border:none;outline:none;
  color:var(--cyan);font-family:'IBM Plex Mono',monospace;
  font-size:.88rem;font-weight:700;letter-spacing:4px;
  text-transform:uppercase;text-align:center;
}
.topbar-room-inp::placeholder{color:var(--b2);letter-spacing:1px;font-size:.75rem;}
.topbar-room-btn{
  padding:7px 14px;border:none;cursor:pointer;
  background:linear-gradient(135deg,var(--cyan),#00a8c0);
  color:#000;font-family:'IBM Plex Mono',monospace;
  font-size:.7rem;font-weight:800;letter-spacing:.5px;
  transition:all .2s;white-space:nowrap;
}
.topbar-room-btn:hover{background:linear-gradient(135deg,#00f0ff,var(--cyan));}
.topbar-room-copy{
  padding:7px 10px;border:none;cursor:pointer;
  background:transparent;color:var(--t2);font-size:13px;
  border-left:1px solid rgba(0,229,255,.2);transition:color .2s;
}
.topbar-room-copy:hover{color:var(--cyan);}
.tb-btn{
  width:34px;height:34px;border-radius:var(--rs);border:1px solid var(--b1);
  background:var(--s1);cursor:pointer;display:grid;place-items:center;
  font-size:15px;transition:all .2s;position:relative;
}
.tb-btn:hover{border-color:var(--cyan);box-shadow:var(--glow-c);}
.tb-badge{
  position:absolute;top:-4px;right:-4px;
  width:15px;height:15px;border-radius:50%;
  background:var(--rose);font-size:9px;font-weight:700;
  display:none;place-items:center;
  font-family:'IBM Plex Mono',monospace;
}
.tb-badge.show{display:grid;}

/* ‚ïê‚ïê‚ïê SIDEBAR ‚ïê‚ïê‚ïê */
.sidebar{
  border-right:1px solid var(--b1);
  background:var(--s1);
  display:flex;flex-direction:column;
  overflow-y:auto;overflow-x:hidden;
  padding:10px 8px;
}
.sidebar-label{
  font-size:.6rem;font-family:'IBM Plex Mono',monospace;
  text-transform:uppercase;letter-spacing:2px;color:var(--t2);
  padding:10px 10px 5px;
}
.nav{
  display:flex;align-items:center;gap:9px;
  padding:9px 10px;border-radius:var(--rs);
  color:var(--t2);font-size:.84rem;font-weight:600;
  cursor:pointer;transition:all .15s;user-select:none;
  position:relative;
}
.nav:hover{background:var(--s2);color:var(--t1);}
.nav.on{
  background:linear-gradient(90deg,rgba(0,229,255,.1),transparent);
  color:var(--cyan);
  border-left:2px solid var(--cyan);
  padding-left:8px;
}
.nav .ni{font-size:16px;width:20px;text-align:center;flex-shrink:0;}
.nav-pill{
  margin-left:auto;background:var(--violet);color:#fff;
  font-size:9px;font-weight:700;padding:1px 6px;border-radius:100px;
  font-family:'IBM Plex Mono',monospace;
}

/* Connection box */
.connect-box{
  margin:8px 4px 4px;
  background:var(--s2);border:1px solid var(--b1);border-radius:var(--r);
  padding:14px;
}
.connect-box h5{font-size:.8rem;font-weight:700;margin-bottom:10px;color:var(--t3);}
.room-inp{
  width:100%;background:var(--bg);border:1px solid var(--b1);
  border-radius:var(--rs);padding:8px 10px;
  color:var(--cyan);font-family:'IBM Plex Mono',monospace;
  font-size:.9rem;font-weight:700;letter-spacing:3px;
  text-align:center;text-transform:uppercase;
  outline:none;transition:border-color .2s;
}
.room-inp:focus{border-color:var(--cyan);}
.room-inp::placeholder{color:var(--b2);letter-spacing:1px;}
.cb-btns{display:flex;gap:6px;margin-top:8px;}
.peer-bar{
  margin-top:10px;padding:10px;
  background:var(--bg);border:1px solid var(--b1);border-radius:var(--rs);
  display:none;
}
.peer-bar.show{display:block;}
.peer-name{font-size:.82rem;font-weight:700;color:var(--cyan);}
.peer-type{font-size:.68rem;color:var(--t2);font-family:'IBM Plex Mono',monospace;margin-top:2px;}

/* ‚ïê‚ïê‚ïê MAIN ‚ïê‚ïê‚ïê */
.main{overflow-y:auto;padding:20px;}
.panel{display:none;flex-direction:column;gap:16px;animation:fadeIn .2s ease;}
.panel.on{display:flex;}
@keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}

/* Card */
.card{
  background:var(--s1);border:1px solid var(--b1);border-radius:var(--r);overflow:hidden;
}
.card-head{
  display:flex;align-items:center;justify-content:space-between;
  padding:14px 18px;border-bottom:1px solid var(--b1);
}
.card-title{font-size:.9rem;font-weight:700;display:flex;align-items:center;gap:8px;}
.card-title .i{font-size:18px;}
.card-actions{display:flex;gap:7px;}
.rtc-bar{
  display:flex;align-items:center;gap:8px;
  padding:7px 18px;background:rgba(0,229,255,.03);border-bottom:1px solid var(--b1);
  font-size:.72rem;font-family:'IBM Plex Mono',monospace;color:var(--t2);
}
.rtc-led{width:5px;height:5px;border-radius:50%;background:var(--t2);transition:all .3s;}
.rtc-led.on{background:var(--emerald);animation:blink 2s infinite;}

/* Buttons */
.btn{
  display:inline-flex;align-items:center;gap:6px;
  padding:8px 15px;border-radius:var(--rs);
  font-family:'Outfit',sans-serif;font-weight:700;font-size:.8rem;
  cursor:pointer;border:none;transition:all .2s;
}
.btn-c{background:linear-gradient(135deg,var(--cyan),#00a8c0);color:#000;}
.btn-c:hover{transform:translateY(-1px);box-shadow:var(--glow-c);}
.btn-v{background:linear-gradient(135deg,var(--violet),#6d28d9);color:#fff;}
.btn-v:hover{transform:translateY(-1px);box-shadow:var(--glow-v);}
.btn-g{background:transparent;border:1px solid var(--b1);color:var(--t2);}
.btn-g:hover{border-color:var(--cyan);color:var(--cyan);}
.btn-r{background:var(--rose);color:#fff;}
.btn-r:hover{background:#e11d48;transform:translateY(-1px);}
.btn-e{background:linear-gradient(135deg,var(--emerald),#059669);color:#fff;}
.btn-e:hover{transform:translateY(-1px);}
.btn-sm{padding:5px 11px;font-size:.72rem;}
.btn:disabled{opacity:.3;cursor:not-allowed;transform:none!important;}

/* ‚ïê‚ïê‚ïê DASHBOARD ‚ïê‚ïê‚ïê */
.stat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;padding:18px;}
.stat{
  background:var(--s2);border:1px solid var(--b1);border-radius:var(--r);
  padding:18px;cursor:default;transition:all .2s;
}
.stat:hover{border-color:var(--cyan);transform:translateY(-2px);}
.stat-ico{font-size:24px;margin-bottom:10px;}
.stat-val{font-size:1.6rem;font-weight:800;color:var(--cyan);font-family:'IBM Plex Mono',monospace;}
.stat-lbl{font-size:.7rem;color:var(--t2);font-family:'IBM Plex Mono',monospace;margin-top:3px;}
.log-list{padding:0 18px 18px;display:flex;flex-direction:column;gap:7px;max-height:260px;overflow-y:auto;}
.log-item{
  display:flex;align-items:center;gap:12px;
  padding:10px 13px;background:var(--s2);border:1px solid var(--b1);
  border-radius:var(--rs);animation:slideIn .25s ease;
}
@keyframes slideIn{from{opacity:0;transform:translateX(-8px)}to{opacity:1;transform:translateX(0)}}
.log-ico{font-size:17px;flex-shrink:0;}
.log-info{flex:1;min-width:0;}
.log-title{font-size:.83rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.log-sub{font-size:.7rem;color:var(--t2);font-family:'IBM Plex Mono',monospace;margin-top:2px;}
.log-time{font-size:.67rem;color:var(--t2);font-family:'IBM Plex Mono',monospace;flex-shrink:0;}

/* ‚ïê‚ïê‚ïê FILE SHARE ‚ïê‚ïê‚ïê */
.drop{
  margin:18px;border:2px dashed var(--b1);border-radius:var(--r);
  padding:40px 20px;text-align:center;cursor:pointer;
  transition:all .2s;position:relative;overflow:hidden;
}
.drop:hover,.drop.over{border-color:var(--cyan);background:rgba(0,229,255,.04);box-shadow:var(--glow-c);}
.drop input{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;}
.drop-ico{font-size:44px;margin-bottom:10px;display:block;}
.drop h3{font-size:.95rem;font-weight:700;}
.drop p{color:var(--t2);font-size:.78rem;margin-top:5px;font-family:'IBM Plex Mono',monospace;}
.file-list{padding:0 18px 18px;display:flex;flex-direction:column;gap:8px;}
.fi{
  display:flex;align-items:center;gap:11px;
  padding:11px 14px;background:var(--s2);border:1px solid var(--b1);
  border-radius:var(--rs);animation:slideIn .25s ease;
}
.fi-ext{
  width:38px;height:38px;border-radius:7px;
  background:linear-gradient(135deg,var(--violet),var(--cyan));
  display:grid;place-items:center;font-size:.58rem;font-weight:800;
  color:#fff;font-family:'IBM Plex Mono',monospace;text-transform:uppercase;flex-shrink:0;
}
.fi-info{flex:1;min-width:0;}
.fi-name{font-size:.86rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.fi-meta{font-size:.7rem;color:var(--t2);font-family:'IBM Plex Mono',monospace;margin-top:2px;}
.prog{height:3px;background:var(--b1);border-radius:2px;margin-top:6px;overflow:hidden;}
.prog-fill{height:100%;background:linear-gradient(90deg,var(--cyan),var(--violet));border-radius:2px;transition:width .3s;}

/* ‚ïê‚ïê‚ïê CLIPBOARD ‚ïê‚ïê‚ïê */
.clip-input{
  margin:18px;background:var(--s2);border:1px solid var(--b1);
  border-radius:var(--r);padding:14px;display:flex;flex-direction:column;gap:10px;
}
.clip-input textarea{
  background:transparent;border:none;color:var(--t1);
  font-family:'IBM Plex Mono',monospace;font-size:.86rem;
  resize:none;outline:none;min-height:90px;
}
.clip-input textarea::placeholder{color:var(--b2);}
.clip-input-btns{display:flex;gap:7px;justify-content:flex-end;}
.clip-hist{padding:0 18px 18px;display:flex;flex-direction:column;gap:7px;}
.ch{
  background:var(--s2);border:1px solid var(--b1);border-radius:var(--rs);
  padding:10px 13px;cursor:pointer;transition:all .2s;animation:slideIn .25s ease;
}
.ch:hover{border-color:var(--emerald);box-shadow:0 0 12px rgba(16,185,129,.15);}
.ch-text{font-family:'IBM Plex Mono',monospace;font-size:.78rem;color:var(--t3);
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.ch-meta{display:flex;justify-content:space-between;margin-top:5px;
  font-size:.67rem;color:var(--t2);font-family:'IBM Plex Mono',monospace;}

/* ‚ïê‚ïê‚ïê SCREEN SHARE ‚ïê‚ïê‚ïê */
.screen-grid{display:grid;grid-template-columns:1fr 260px;min-height:460px;}
.screen-area{padding:18px;display:flex;flex-direction:column;gap:12px;border-right:1px solid var(--b1);}
.viewport{
  position:relative;background:#000;border-radius:var(--r);
  aspect-ratio:16/9;border:2px solid var(--b1);
  display:flex;align-items:center;justify-content:center;
  overflow:hidden;transition:border-color .3s;
}
.viewport.sharing{border-color:var(--rose);box-shadow:0 0 24px rgba(244,63,94,.25);}
.viewport.viewing{border-color:var(--cyan);box-shadow:var(--glow-c);}
.viewport video{width:100%;height:100%;object-fit:contain;}
.vp-ph{display:flex;flex-direction:column;align-items:center;gap:10px;color:var(--t2);text-align:center;padding:20px;}
.vp-ph .big{font-size:50px;}
.vp-ph h3{font-size:.9rem;font-weight:700;color:var(--t3);}
.vp-ph p{font-size:.72rem;font-family:'IBM Plex Mono',monospace;}
.live-tag{
  position:absolute;top:10px;left:10px;
  background:var(--rose);color:#fff;
  font-size:.65rem;font-weight:800;font-family:'IBM Plex Mono',monospace;
  padding:3px 9px;border-radius:100px;
  display:none;align-items:center;gap:5px;
}
.live-tag.show{display:flex;}
.live-dot{width:5px;height:5px;border-radius:50%;background:#fff;animation:blink 1s infinite;}
.ss-stats{display:flex;gap:8px;}
.sst{flex:1;background:var(--s2);border:1px solid var(--b1);border-radius:var(--rs);padding:8px 11px;}
.sst label{display:block;font-size:.62rem;color:var(--t2);font-family:'IBM Plex Mono',monospace;text-transform:uppercase;letter-spacing:1px;}
.sst value{display:block;font-size:.9rem;font-weight:700;color:var(--cyan);font-family:'IBM Plex Mono',monospace;margin-top:1px;}
.ss-ctrl{display:flex;gap:7px;flex-wrap:wrap;}
.screen-side{padding:16px;display:flex;flex-direction:column;gap:12px;}
.side-card{background:var(--s2);border:1px solid var(--b1);border-radius:var(--r);padding:13px;}
.side-card h5{font-size:.75rem;font-weight:700;color:var(--t2);margin-bottom:10px;font-family:'IBM Plex Mono',monospace;text-transform:uppercase;letter-spacing:1px;}
.opt-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;font-size:.78rem;color:var(--t3);}
.tog{width:40px;height:20px;background:var(--b1);border-radius:100px;position:relative;cursor:pointer;transition:background .2s;}
.tog.on{background:var(--cyan);}
.tog::after{content:'';position:absolute;top:3px;left:3px;width:14px;height:14px;background:#fff;border-radius:50%;transition:transform .2s;box-shadow:0 1px 3px rgba(0,0,0,.4);}
.tog.on::after{transform:translateX(20px);}
.annotate-canvas{
  border:1px solid var(--cyan);border-radius:var(--rs);
  cursor:crosshair;width:100%;display:none;margin-top:6px;
}

/* ‚ïê‚ïê‚ïê NOTIFICATIONS ‚ïê‚ïê‚ïê */
.notif-list{padding:18px;display:flex;flex-direction:column;gap:10px;}
.notif{
  display:flex;gap:12px;padding:14px;
  background:var(--s2);border:1px solid var(--b1);border-radius:var(--r);
  animation:slideIn .25s ease;position:relative;overflow:hidden;
}
.notif::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--violet);}
.notif.unread::before{background:var(--cyan);}
.notif-app-ico{width:36px;height:36px;border-radius:9px;display:grid;place-items:center;font-size:17px;background:var(--bg);flex-shrink:0;}
.notif-body{flex:1;}
.notif-hd{display:flex;justify-content:space-between;align-items:flex-start;}
.notif-app{font-size:.68rem;color:var(--cyan);font-weight:700;font-family:'IBM Plex Mono',monospace;text-transform:uppercase;}
.notif-t{font-size:.67rem;color:var(--t2);font-family:'IBM Plex Mono',monospace;}
.notif-title{font-size:.86rem;font-weight:700;margin-top:3px;}
.notif-text{font-size:.78rem;color:var(--t3);margin-top:3px;line-height:1.5;}
.notif-acts{display:flex;gap:6px;margin-top:8px;}

/* ‚ïê‚ïê‚ïê MESSAGES ‚ïê‚ïê‚ïê */
.msg-layout{display:grid;grid-template-columns:240px 1fr;height:480px;}
.contacts{border-right:1px solid var(--b1);overflow-y:auto;padding:8px;}
.contact{
  display:flex;align-items:center;gap:9px;
  padding:9px 10px;border-radius:var(--rs);cursor:pointer;transition:all .15s;
}
.contact:hover{background:var(--s2);}
.contact.on{background:rgba(0,229,255,.07);}
.av{width:34px;height:34px;border-radius:50%;display:grid;place-items:center;font-size:13px;font-weight:700;color:#fff;flex-shrink:0;}
.ci{flex:1;min-width:0;}
.cn{font-size:.83rem;font-weight:600;}
.cp{font-size:.7rem;color:var(--t2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.cu{background:var(--cyan);color:#000;font-size:9px;width:16px;height:16px;border-radius:50%;display:grid;place-items:center;font-weight:700;flex-shrink:0;}
.chat-wrap{display:flex;flex-direction:column;}
.chat-head{padding:11px 16px;border-bottom:1px solid var(--b1);display:flex;align-items:center;gap:10px;}
.chat-msgs{flex:1;padding:12px 16px;overflow-y:auto;display:flex;flex-direction:column;gap:7px;}
.msg{max-width:70%;animation:slideIn .2s ease;}
.msg.out{margin-left:auto;}
.mb{padding:9px 12px;border-radius:10px;font-size:.84rem;line-height:1.5;}
.msg.in .mb{background:var(--s2);border:1px solid var(--b1);border-bottom-left-radius:3px;}
.msg.out .mb{background:linear-gradient(135deg,var(--violet),#4c1d95);color:#fff;border-bottom-right-radius:3px;}
.mt{font-size:.64rem;color:var(--t2);margin-top:3px;font-family:'IBM Plex Mono',monospace;}
.msg.out .mt{text-align:right;}
.chat-in{padding:11px 16px;border-top:1px solid var(--b1);display:flex;gap:8px;align-items:center;}
.ci-inp{flex:1;background:var(--s2);border:1px solid var(--b1);border-radius:100px;padding:9px 15px;color:var(--t1);font-family:'Outfit',sans-serif;font-size:.84rem;outline:none;transition:border-color .2s;}
.ci-inp:focus{border-color:var(--violet);}
.ci-inp::placeholder{color:var(--b2);}
.send{width:36px;height:36px;background:linear-gradient(135deg,var(--violet),var(--cyan));border:none;border-radius:50%;cursor:pointer;display:grid;place-items:center;font-size:15px;transition:all .2s;flex-shrink:0;}
.send:hover{transform:scale(1.1);box-shadow:var(--glow-v);}

/* ‚ïê‚ïê‚ïê PAIR ‚ïê‚ïê‚ïê */
.pair-area{display:flex;flex-direction:column;align-items:center;padding:36px 18px;gap:18px;text-align:center;}
.pair-code{
  font-family:'IBM Plex Mono',monospace;font-size:2rem;font-weight:700;
  letter-spacing:10px;color:var(--cyan);
  padding:16px 24px;background:var(--s2);border:1px solid var(--b1);border-radius:var(--r);
  text-shadow:var(--glow-c);
}
.pair-steps{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;max-width:540px;}
.pstep{background:var(--s2);border:1px solid var(--b1);border-radius:var(--r);padding:14px;flex:1;min-width:130px;}
.pstep .n{width:28px;height:28px;background:linear-gradient(135deg,var(--cyan),var(--violet));border-radius:50%;display:grid;place-items:center;font-size:.8rem;font-weight:800;color:#000;margin:0 auto 8px;}
.pstep h4{font-size:.83rem;font-weight:700;}
.pstep p{font-size:.72rem;color:var(--t2);margin-top:3px;font-family:'IBM Plex Mono',monospace;}
.pair-status{font-family:'IBM Plex Mono',monospace;font-size:.8rem;color:var(--t2);padding:10px 16px;background:var(--s2);border:1px solid var(--b1);border-radius:var(--rs);}

/* ‚ïê‚ïê‚ïê SETTINGS ‚ïê‚ïê‚ïê */
.settings-rows{display:flex;flex-direction:column;}
.sr{display:flex;align-items:center;justify-content:space-between;padding:13px 18px;border-bottom:1px solid var(--b1);}
.sr:last-child{border-bottom:none;}
.sr-info h4{font-size:.86rem;font-weight:700;}
.sr-info p{font-size:.75rem;color:var(--t2);font-family:'IBM Plex Mono',monospace;margin-top:2px;}

/* ‚ïê‚ïê‚ïê REMOTE FILE BROWSER ‚ïê‚ïê‚ïê */
.rfb-item{
  display:flex;align-items:center;gap:10px;
  padding:9px 12px;background:var(--s2);border:1px solid var(--b1);
  border-radius:var(--rs);transition:all .15s;animation:slideIn .2s ease;
}
.rfb-item:hover{border-color:var(--cyan);}
.rfb-item.folder{cursor:pointer;}
.rfb-item.folder:hover{background:rgba(0,229,255,.05);}
.rfb-ico{font-size:20px;flex-shrink:0;width:28px;text-align:center;}
.rfb-info{flex:1;min-width:0;}
.rfb-name{font-size:.83rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.rfb-meta{font-size:.68rem;color:var(--t2);font-family:'IBM Plex Mono',monospace;margin-top:2px;}
.rfb-dl{padding:5px 12px;border-radius:var(--rs);border:1px solid var(--b1);background:transparent;
  color:var(--cyan);font-size:.72rem;font-weight:700;cursor:pointer;transition:all .2s;white-space:nowrap;}
.rfb-dl:hover{background:rgba(0,229,255,.1);border-color:var(--cyan);}
.rfb-dl:disabled{opacity:.35;cursor:not-allowed;}
.rfb-prog{height:2px;background:var(--b1);border-radius:2px;margin-top:5px;overflow:hidden;display:none;}
.rfb-prog-fill{height:100%;background:linear-gradient(90deg,var(--cyan),var(--violet));border-radius:2px;transition:width .3s;}
.rfb-breadcrumb{display:flex;align-items:center;gap:4px;padding:8px 18px;border-bottom:1px solid var(--b1);
  flex-wrap:wrap;font-size:.75rem;font-family:'IBM Plex Mono',monospace;}
.rfb-crumb{color:var(--cyan);cursor:pointer;}
.rfb-crumb:hover{text-decoration:underline;}
.rfb-sep{color:var(--b2);}

/* ‚ïê‚ïê‚ïê REMOTE KEYBOARD ‚ïê‚ïê‚ïê */
.kbd-wrap{padding:16px 18px;display:flex;flex-direction:column;gap:14px;}
.kbd-display{
  background:var(--bg);border:1px solid var(--b1);border-radius:var(--rs);
  padding:12px 14px;font-family:'IBM Plex Mono',monospace;font-size:.9rem;
  color:var(--cyan);min-height:52px;letter-spacing:1px;word-break:break-all;
  display:flex;align-items:center;gap:6px;
}
.kbd-cursor{display:inline-block;width:2px;height:1.1em;background:var(--cyan);animation:blink .8s steps(1) infinite;margin-left:1px;}
.kbd-row{display:flex;gap:5px;justify-content:center;flex-wrap:wrap;}
.k{
  min-width:36px;height:36px;padding:0 8px;
  background:var(--s2);border:1px solid var(--b1);border-radius:6px;
  color:var(--t1);font-size:.78rem;font-weight:600;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  transition:all .1s;user-select:none;font-family:'IBM Plex Mono',monospace;
}
.k:hover{background:var(--b1);border-color:var(--cyan);}
.k:active{transform:scale(.92);background:var(--cyan);color:#000;}
.k.wide{min-width:60px;}
.k.xwide{min-width:90px;}
.k.spec{background:var(--s3);color:var(--t2);}
.k.spec:hover{color:var(--t1);}
.k.active-mod{background:rgba(0,229,255,.2);border-color:var(--cyan);color:var(--cyan);}
.kbd-special-row{display:flex;gap:7px;justify-content:center;flex-wrap:wrap;margin-top:2px;}
.kbd-text-inp{
  background:var(--s2);border:1px solid var(--b1);border-radius:var(--rs);
  padding:10px 14px;color:var(--t1);font-family:'IBM Plex Mono',monospace;font-size:.86rem;
  outline:none;width:100%;transition:border-color .2s;
}
.kbd-text-inp:focus{border-color:var(--violet);}
.kbd-text-inp::placeholder{color:var(--b2);}

/* ‚ïê‚ïê‚ïê SHARED STORAGE ‚ïê‚ïê‚ïê */
.storage-toolbar{display:flex;gap:8px;padding:14px 18px;border-bottom:1px solid var(--b1);flex-wrap:wrap;align-items:center;}
.storage-inp{background:var(--bg);border:1px solid var(--b1);border-radius:var(--rs);padding:7px 11px;color:var(--t1);font-family:'IBM Plex Mono',monospace;font-size:.78rem;outline:none;transition:border-color .2s;}
.storage-inp:focus{border-color:var(--cyan);}
.storage-inp::placeholder{color:var(--b2);}
.storage-entries{padding:14px 18px;display:flex;flex-direction:column;gap:8px;}
.se{display:flex;align-items:stretch;gap:0;background:var(--s2);border:1px solid var(--b1);border-radius:var(--rs);overflow:hidden;animation:slideIn .25s ease;}
.se-key{padding:10px 13px;font-family:'IBM Plex Mono',monospace;font-size:.78rem;color:var(--cyan);font-weight:700;min-width:120px;border-right:1px solid var(--b1);background:rgba(0,229,255,.04);}
.se-val{padding:10px 13px;font-family:'IBM Plex Mono',monospace;font-size:.78rem;color:var(--t3);flex:1;word-break:break-all;}
.se-src{padding:10px 8px;font-size:.62rem;color:var(--t2);font-family:'IBM Plex Mono',monospace;display:flex;flex-direction:column;align-items:center;gap:2px;border-left:1px solid var(--b1);}
.se-del{padding:6px 10px;background:transparent;border:none;border-left:1px solid var(--b1);color:var(--rose);cursor:pointer;font-size:13px;transition:background .15s;}
.se-del:hover{background:rgba(244,63,94,.1);}
.storage-info{padding:12px 18px;background:rgba(0,229,255,.04);border-top:1px solid var(--b1);font-size:.72rem;color:var(--t2);font-family:'IBM Plex Mono',monospace;display:flex;align-items:center;gap:8px;}

/* ‚ïê‚ïê‚ïê HOW IT WORKS banner ‚ïê‚ïê‚ïê */
.how-banner{
  display:flex;align-items:center;gap:14px;flex-wrap:wrap;
  padding:12px 18px;
  background:linear-gradient(90deg,rgba(0,229,255,.07),rgba(139,92,246,.07));
  border:1px solid rgba(0,229,255,.2);border-radius:var(--r);
  margin-bottom:4px;
}
.how-banner p{font-size:.78rem;color:var(--t3);font-family:'IBM Plex Mono',monospace;line-height:1.6;}
.how-banner strong{color:var(--cyan);}

/* ‚ïê‚ïê‚ïê TOAST ‚ïê‚ïê‚ïê */
.toasts{position:fixed;bottom:18px;right:18px;display:flex;flex-direction:column;gap:7px;z-index:9999;}
.toast{
  background:var(--s2);border:1px solid var(--b1);border-radius:var(--r);
  padding:11px 15px;min-width:250px;max-width:320px;
  display:flex;gap:10px;align-items:flex-start;
  animation:toastIn .3s ease;
  box-shadow:0 8px 32px rgba(0,0,0,.5);
}
@keyframes toastIn{from{opacity:0;transform:translateX(60px)}to{opacity:1;transform:translateX(0)}}
.toast.ok{border-left:3px solid var(--emerald);}
.toast.info{border-left:3px solid var(--cyan);}
.toast.warn{border-left:3px solid var(--amber);}
.toast.err{border-left:3px solid var(--rose);}
.toast-ico{font-size:17px;flex-shrink:0;margin-top:1px;}
.toast-title{font-size:.84rem;font-weight:700;}
.toast-body{font-size:.72rem;color:var(--t2);font-family:'IBM Plex Mono',monospace;margin-top:2px;}

/* ‚ïê‚ïê‚ïê CONNECTING OVERLAY ‚ïê‚ïê‚ïê */
.overlay{
  display:none;position:fixed;inset:0;
  background:rgba(6,8,16,.85);backdrop-filter:blur(8px);
  z-index:200;place-items:center;
  flex-direction:column;gap:20px;
}
.overlay.show{display:flex;}
.spinner{
  width:56px;height:56px;border-radius:50%;
  border:3px solid var(--b1);border-top-color:var(--cyan);
  animation:rot .8s linear infinite;
}
@keyframes rot{to{transform:rotate(360deg)}}
.overlay p{font-size:.9rem;font-family:'IBM Plex Mono',monospace;color:var(--t3);}

@media(max-width:700px){
  .app{grid-template-columns:1fr;grid-template-rows:58px auto 1fr;}
  .sidebar{display:none;}
  .screen-grid,.msg-layout{grid-template-columns:1fr;}
}
</style>
</head>
<body>
<div class="app">

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TOPBAR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<header class="topbar">
  <div class="logo"><div class="logo-mark">‚ö°</div>Cross<span>Connect</span></div>
  <div class="topbar-mid">
    <div class="conn-badge" onclick="go('pair')">
      <div class="led" id="mainLed"></div>
      <span id="mainStatus">Not Connected</span>
    </div>
    <div style="font-family:'IBM Plex Mono',monospace;font-size:.68rem;color:var(--t2)" id="myIdDisplay"></div>
  </div>
  <div class="topbar-room">
    <span class="topbar-room-label">Room</span>
    <input class="topbar-room-inp" id="topbarRoomInp" maxlength="8" placeholder="XXXXXX"
      oninput="syncRoomInputs(this.value)"
      onkeydown="if(event.key==='Enter')connectRoom()"/>
    <button class="topbar-room-btn" onclick="connectRoom()">Connect</button>
    <button class="topbar-room-copy" onclick="copyTopbarCode()" title="Copy room code">üìã</button>
  </div>
  <div class="topbar-right">
    <div class="tb-btn" onclick="go('notifications')" title="Notifications">üîî<div class="tb-badge" id="notifBadge">0</div></div>
    <div class="tb-btn" onclick="go('settings')" title="Settings">‚öôÔ∏è</div>
  </div>
</header>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SIDEBAR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<aside class="sidebar">
  <div class="sidebar-label">Navigation</div>
  <div class="nav on" data-p="dashboard" onclick="go('dashboard')"><span class="ni">üè†</span>Dashboard</div>
  <div class="nav" data-p="files" onclick="go('files')"><span class="ni">üìÅ</span>File Share<span class="nav-pill" id="fileCount">0</span></div>
  <div class="nav" data-p="clipboard" onclick="go('clipboard')"><span class="ni">üìã</span>Clipboard</div>
  <div class="nav" data-p="notifications" onclick="go('notifications')"><span class="ni">üîî</span>Notifications</div>
  <div class="nav" data-p="messages" onclick="go('messages')"><span class="ni">üí¨</span>Messages</div>
  <div class="nav" data-p="screenshare" onclick="go('screenshare')"><span class="ni">üñ•Ô∏è</span>Screen Share</div>
  <div class="nav" data-p="storage" onclick="go('storage')"><span class="ni">üóÑÔ∏è</span>File Browser</div>
  <div class="nav" data-p="keyboard" onclick="go('keyboard')"><span class="ni">‚å®Ô∏è</span>Remote Keyboard</div>
  <div class="sidebar-label" style="margin-top:6px">Device</div>
  <div class="nav" data-p="pair" onclick="go('pair')"><span class="ni">üîó</span>Pair Device</div>
  <div class="nav" data-p="settings" onclick="go('settings')"><span class="ni">‚öôÔ∏è</span>Settings</div>

  <div class="connect-box">
    <h5>Room Code</h5>
    <input class="room-inp" id="roomInp" maxlength="8" placeholder="XXXXXX" oninput="syncRoomInputs(this.value)"/>
    <div class="cb-btns">
      <button class="btn btn-c btn-sm" style="flex:1" onclick="connectRoom()">Connect</button>
      <button class="btn btn-g btn-sm" onclick="genCode()">Gen</button>
    </div>
    <div class="peer-bar" id="peerBar">
      <div class="peer-name" id="peerNameEl">‚Äî</div>
      <div class="peer-type" id="peerTypeEl">‚Äî</div>
    </div>
  </div>
</aside>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAIN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<main class="main">

  <!-- DASHBOARD -->
  <div class="panel on" id="pg-dashboard">
    <div class="how-banner">
      <span style="font-size:28px">‚ö°</span>
      <p><strong>100% browser-based P2P.</strong> No server. No install. Uses PeerJS free cloud for handshake, then direct device-to-device WebRTC. Works on any device with Chrome/Firefox/Edge. Just share the same room code!</p>
    </div>
    <div class="card">
      <div class="card-head">
        <div class="card-title"><span class="i">üè†</span>Dashboard</div>
        <div class="card-actions"><span id="dashInfo" style="font-size:.72rem;color:var(--t2);font-family:'IBM Plex Mono',monospace">Enter room code ‚Üí Connect</span></div>
      </div>
      <div class="stat-grid">
        <div class="stat" onclick="go('files')"><div class="stat-ico">üì§</div><div class="stat-val" id="dSent">0</div><div class="stat-lbl">Files Sent</div></div>
        <div class="stat" onclick="go('files')"><div class="stat-ico">üì•</div><div class="stat-val" id="dRecv">0</div><div class="stat-lbl">Files Received</div></div>
        <div class="stat" onclick="go('clipboard')"><div class="stat-ico">üìã</div><div class="stat-val" id="dClip">0</div><div class="stat-lbl">Clipboard Syncs</div></div>
        <div class="stat"><div class="stat-ico">üì¶</div><div class="stat-val" id="dBytes">0B</div><div class="stat-lbl">Data Moved</div></div>
      </div>
      <div class="card-head" style="border-top:1px solid var(--b1)"><div class="card-title" style="font-size:.82rem"><span class="i">‚ö°</span>Live Activity</div></div>
      <div class="log-list" id="logList"><div style="text-align:center;padding:20px;font-size:.78rem;color:var(--t2);font-family:'IBM Plex Mono',monospace">Connect a device to see activity</div></div>
    </div>
  </div>

  <!-- FILES -->
  <div class="panel" id="pg-files">
    <div class="card">
      <div class="card-head">
        <div class="card-title"><span class="i">üìÅ</span>File Share</div>
        <div class="card-actions">
          <span id="fileWarn" style="font-size:.72rem;color:var(--amber);font-family:'IBM Plex Mono',monospace">‚ö† Connect a device first</span>
          <button class="btn btn-g btn-sm" onclick="clearFiles()">Clear</button>
        </div>
      </div>
      <div class="rtc-bar"><div class="rtc-led" id="fileRtcLed"></div><span id="fileRtcTxt">DataChannel ¬∑ Waiting</span></div>
      <div class="drop" id="dropZone">
        <input type="file" multiple id="fileInput" onchange="handleFiles(this.files)"/>
        <span class="drop-ico">üì¶</span>
        <h3>Drop files to send to connected device</h3>
        <p>Any file type ¬∑ Chunked WebRTC transfer ¬∑ End-to-end encrypted</p>
      </div>
      <div class="file-list" id="fileList"></div>
    </div>
  </div>

  <!-- CLIPBOARD -->
  <div class="panel" id="pg-clipboard">
    <div class="card">
      <div class="card-head">
        <div class="card-title"><span class="i">üìã</span>Clipboard Sync</div>
        <div class="card-actions">
          <button class="btn btn-g btn-sm" onclick="readSysClip()">üìñ Read System</button>
        </div>
      </div>
      <div class="rtc-bar"><div class="rtc-led" id="clipRtcLed"></div><span id="clipRtcTxt">DataChannel ¬∑ Waiting</span></div>
      <div class="clip-input">
        <textarea id="clipTA" placeholder="Type or paste text here to sync to the connected device..."></textarea>
        <div class="clip-input-btns">
          <button class="btn btn-g btn-sm" onclick="document.getElementById('clipTA').value=''">Clear</button>
          <button class="btn btn-c btn-sm" onclick="sendClip()">üì§ Sync to Device</button>
        </div>
      </div>
      <div class="card-head" style="border-top:1px solid var(--b1)">
        <div class="card-title" style="font-size:.82rem"><span class="i">üïê</span>History</div>
        <button class="btn btn-g btn-sm" onclick="clipHist=[];renderClipHist()">Clear</button>
      </div>
      <div class="clip-hist" id="clipHistEl"></div>
    </div>
  </div>

  <!-- NOTIFICATIONS -->
  <div class="panel" id="pg-notifications">
    <div class="card">
      <div class="card-head">
        <div class="card-title"><span class="i">üîî</span>Notifications</div>
        <div class="card-actions">
          <button class="btn btn-g btn-sm" onclick="askNotifPerm()">Enable Push</button>
          <button class="btn btn-g btn-sm" onclick="clearNotifs()">Clear All</button>
        </div>
      </div>
      <div class="notif-list" id="notifList">
        <div style="text-align:center;padding:30px;color:var(--t2);font-family:'IBM Plex Mono',monospace;font-size:.8rem">Connect your phone to mirror its notifications here</div>
      </div>
    </div>
  </div>

  <!-- MESSAGES -->
  <div class="panel" id="pg-messages">
    <div class="card">
      <div class="card-head"><div class="card-title"><span class="i">üí¨</span>Messages (SMS / RCS)</div></div>
      <div class="msg-layout">
        <div class="contacts" id="contactsEl">
          <div style="font-size:.76rem;color:var(--t2);font-family:'IBM Plex Mono',monospace;text-align:center;padding:20px">Connect phone to load contacts</div>
        </div>
        <div class="chat-wrap">
          <div class="chat-head">
            <div class="av" id="chatAv" style="background:linear-gradient(135deg,#7c3aed,#3b82f6)">?</div>
            <div><div style="font-weight:700;font-size:.86rem" id="chatName">Select a conversation</div><div style="font-size:.67rem;color:var(--t2);font-family:'IBM Plex Mono',monospace">via CrossConnect</div></div>
          </div>
          <div class="chat-msgs" id="chatMsgs"><div style="text-align:center;padding:20px;color:var(--t2);font-size:.8rem;font-family:'IBM Plex Mono',monospace">No conversation selected</div></div>
          <div class="chat-in">
            <input class="ci-inp" id="chatInp" placeholder="Type a message..." onkeypress="if(event.key==='Enter')sendMsg()"/>
            <button class="send" onclick="sendMsg()">‚û§</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SCREEN SHARE -->
  <div class="panel" id="pg-screenshare">
    <div class="card">
      <div class="card-head">
        <div class="card-title"><span class="i">üñ•Ô∏è</span>Screen Share</div>
        <div class="card-actions">
          <button class="btn btn-g btn-sm" id="reqPhoneBtn" onclick="requestRemoteScreen()">üì± View Device</button>
          <button class="btn btn-e btn-sm" id="startShareBtn" onclick="startShare()">üì° Share My Screen</button>
          <button class="btn btn-r btn-sm" id="stopShareBtn" onclick="stopShare()" style="display:none">‚èπ Stop</button>
        </div>
      </div>
      <div class="rtc-bar"><div class="rtc-led" id="screenRtcLed"></div><span id="screenRtcTxt">Screen Channel ¬∑ Ready</span></div>
      <div class="screen-grid">
        <div class="screen-area">
          <div class="viewport" id="viewport">
            <div class="live-tag" id="liveTag"><div class="live-dot"></div>LIVE</div>
            <div class="vp-ph" id="vpPh"><div class="big">üñ•Ô∏è</div><h3>No active session</h3><p>Share your screen or view the connected device</p></div>
            <video id="screenVid" autoplay muted playsinline style="display:none"></video>
          </div>
          <div class="ss-stats" id="ssStats" style="opacity:.3">
            <div class="sst"><label>Resolution</label><value id="ssRes">‚Äî</value></div>
            <div class="sst"><label>FPS</label><value id="ssFps">‚Äî</value></div>
            <div class="sst"><label>Latency</label><value id="ssLat">‚Äî</value></div>
            <div class="sst"><label>Duration</label><value id="ssDur">00:00</value></div>
          </div>
          <div class="ss-ctrl">
            <button class="btn btn-g btn-sm" id="annotBtn" onclick="toggleAnnotate()">‚úèÔ∏è Annotate</button>
            <button class="btn btn-g btn-sm" onclick="doScreenshot()">üì∏ Screenshot</button>
            <button class="btn btn-g btn-sm" id="micBtn" onclick="toggleMic()">üé§ Mic On</button>
            <button class="btn btn-g btn-sm" onclick="doFullscreen()">‚õ∂ Fullscreen</button>
          </div>
          <canvas id="annotCanvas" class="annotate-canvas" height="200"></canvas>
        </div>
        <div class="screen-side">
          <div class="side-card">
            <h5>Options</h5>
            <div class="opt-row"><label>System Audio</label><div class="tog on" id="audioTog" onclick="this.classList.toggle('on')"></div></div>
            <div class="opt-row"><label>Show Cursor</label><div class="tog on" onclick="this.classList.toggle('on')"></div></div>
            <div class="opt-row"><label>Encrypt</label><div class="tog on"></div></div>
          </div>
          <div class="side-card">
            <h5>Share Link</h5>
            <div id="roomShareLink" style="font-family:'IBM Plex Mono',monospace;font-size:.7rem;color:var(--cyan);word-break:break-all">Start sharing for a link</div>
            <button class="btn btn-g btn-sm" style="margin-top:8px;width:100%" onclick="copyRoomLink()">Copy</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- PAIR -->
  <div class="panel" id="pg-pair">
    <div class="card">
      <div class="card-head"><div class="card-title"><span class="i">üîó</span>Pair a Device</div></div>
      <div class="pair-area">
        <p style="color:var(--t2);font-family:'IBM Plex Mono',monospace;font-size:.8rem;max-width:500px">Open CrossConnect on any other device and enter the same room code. Works across WiFi, 4G, any network ‚Äî powered by WebRTC P2P.</p>
        <div class="pair-code" id="pairCodeEl">‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center">
          <button class="btn btn-c" onclick="genCode();connectRoom()">üé≤ Generate & Connect</button>
          <button class="btn btn-g" onclick="genCode()">üîÑ New Code</button>
        </div>
        <div class="pair-status" id="pairStatusEl">Waiting ‚Äî enter or generate a room code to start</div>
        <div class="pair-steps">
          <div class="pstep"><div class="n">1</div><h4>Open App</h4><p>On any other device, open this same website URL</p></div>
          <div class="pstep"><div class="n">2</div><h4>Same Code</h4><p>Enter the identical room code in the sidebar</p></div>
          <div class="pstep"><div class="n">3</div><h4>Connect</h4><p>Click Connect ‚Äî WebRTC handshake happens automatically</p></div>
          <div class="pstep"><div class="n">4</div><h4>Go!</h4><p>Share files, screen, clipboard ‚Äî all P2P encrypted</p></div>
        </div>
      </div>
    </div>
  </div>

  <!-- REMOTE FILE BROWSER -->
  <div class="panel" id="pg-storage">
    <div class="card">
      <div class="card-head">
        <div class="card-title"><span class="i">üóÑÔ∏è</span>Remote File Browser</div>
        <div class="card-actions">
          <button class="btn btn-e btn-sm" id="shareFolderBtn" onclick="shareFolder()">üìÇ Share a Folder</button>
          <button class="btn btn-g btn-sm" id="stopFolderBtn" onclick="stopFolderShare()" style="display:none">‚èπ Stop Sharing</button>
        </div>
      </div>
      <div class="rtc-bar"><div class="rtc-led" id="storeRtcLed"></div><span id="storeRtcTxt">Remote Files ¬∑ Connect a device, then share a folder</span></div>

      <!-- HOST side: folder tree -->
      <div id="rfbHostArea" style="display:none">
        <div style="padding:12px 18px;background:rgba(16,185,129,.06);border-bottom:1px solid var(--b1);display:flex;align-items:center;gap:10px;">
          <span style="font-size:20px">üìÇ</span>
          <div>
            <div style="font-size:.84rem;font-weight:700;color:var(--emerald)" id="rfbFolderName">‚Äî</div>
            <div style="font-size:.7rem;color:var(--t2);font-family:'IBM Plex Mono',monospace" id="rfbFileCount">0 files</div>
          </div>
          <span style="margin-left:auto;font-size:.7rem;color:var(--emerald);font-family:'IBM Plex Mono',monospace;background:rgba(16,185,129,.1);padding:3px 10px;border-radius:100px">‚óè SHARING</span>
        </div>
        <div style="padding:14px 18px;font-size:.75rem;color:var(--t2);font-family:'IBM Plex Mono',monospace">
          Peer can browse and download files from this folder. Sharing happens P2P ‚Äî files never leave your device until requested.
        </div>
      </div>

      <!-- BROWSER side: remote file list -->
      <div id="rfbBrowserArea" style="display:none">
        <div style="padding:10px 18px;border-bottom:1px solid var(--b1);display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
          <span style="font-size:.72rem;color:var(--t2);font-family:'IBM Plex Mono',monospace">Remote:</span>
          <span style="font-size:.82rem;font-weight:700;color:var(--cyan)" id="rfbRemoteName">‚Äî</span>
          <span style="font-size:.7rem;color:var(--t2);font-family:'IBM Plex Mono',monospace;margin-left:4px" id="rfbRemoteCount"></span>
          <button class="btn btn-g btn-sm" style="margin-left:auto" onclick="rfbRefresh()">üîÑ Refresh</button>
        </div>
        <div id="rfbFileList" style="padding:10px 18px;display:flex;flex-direction:column;gap:6px;max-height:400px;overflow-y:auto;"></div>
      </div>

      <!-- Empty state -->
      <div id="rfbEmptyState" style="padding:36px 18px;text-align:center;color:var(--t2)">
        <div style="font-size:48px;margin-bottom:12px">üìÅ</div>
        <div style="font-weight:700;font-size:.9rem;color:var(--t3);margin-bottom:8px">Remote File Browser</div>
        <div style="font-size:.78rem;font-family:'IBM Plex Mono',monospace;line-height:1.7;max-width:420px;margin:0 auto">
          Browse and download files directly from the connected device.<br>
          <strong style="color:var(--cyan)">On the other device:</strong> click <strong>"Share a Folder"</strong> ‚Äî the file list will appear here instantly via P2P.<br><br>
          <span style="color:var(--amber)">‚ö† Why not access storage directly?</span><br>
          Browsers sandbox all file access for security. This is why apps like Chrome can't read your files without permission ‚Äî it protects you from malicious sites. CrossConnect uses the <strong>File System Access API</strong> + P2P so the other device consciously chooses what folder to share.
        </div>
      </div>

    </div>

    <!-- Clipboard-style sync strip below -->
    <div class="card">
      <div class="card-head">
        <div class="card-title"><span class="i">üìù</span>Shared Clipboard Notes</div>
        <div class="card-actions">
          <button class="btn btn-g btn-sm" onclick="storagePushAll()">üì° Push All</button>
          <button class="btn btn-r btn-sm" onclick="storageClearAll()">üóë Clear</button>
        </div>
      </div>
      <div class="storage-toolbar">
        <input class="storage-inp" id="storeKeyInp" placeholder="Label" style="width:130px" maxlength="64"/>
        <input class="storage-inp" id="storeValInp" placeholder="Value / note to sync to peer" style="flex:1;min-width:140px" maxlength="2048"/>
        <button class="btn btn-c btn-sm" onclick="storageSet()">‚ûï Sync</button>
      </div>
      <div class="storage-entries" id="storageEntries">
        <div data-empty style="text-align:center;padding:20px;color:var(--t2);font-size:.78rem;font-family:'IBM Plex Mono',monospace">
          Sync notes, links, passwords, or any text between devices instantly.
        </div>
      </div>
    </div>
  </div>


  <!-- REMOTE KEYBOARD -->
  <div class="panel" id="pg-keyboard">
    <div class="card">
      <div class="card-head">
        <div class="card-title"><span class="i">‚å®Ô∏è</span>Remote Keyboard</div>
        <div class="card-actions">
          <button class="btn btn-g btn-sm" onclick="kbdClear()">üóë Clear</button>
          <button class="btn btn-c btn-sm" onclick="kbdSendAll()">üì§ Send All Text</button>
        </div>
      </div>
      <div class="rtc-bar"><div class="rtc-led" id="kbdRtcLed"></div><span id="kbdRtcTxt">Remote Keyboard ¬∑ Connect a device to type remotely</span></div>
      <div class="kbd-wrap">
        <!-- Live display of what you're typing -->
        <div class="kbd-display" id="kbdDisplay"><span id="kbdText"></span><span class="kbd-cursor"></span></div>
        
        <!-- Free-type input (mobile keyboard opens here) -->
        <input class="kbd-text-inp" id="kbdFreeInp" placeholder="Tap here to type with your device keyboard ‚Äî text goes to peer‚Ä¶"
          oninput="kbdFreeType(this.value)" onkeydown="kbdFreeKey(event)"/>

        <div style="font-size:.7rem;color:var(--t2);font-family:'IBM Plex Mono',monospace;text-align:center;margin:-6px 0 2px">‚Äî or use the virtual keyboard below ‚Äî</div>

        <!-- Function keys row -->
        <div class="kbd-row">
          <div class="k spec xwide" onclick="kbdKey('Escape')">Esc</div>
          <div class="k spec wide" onclick="kbdKey('F1')">F1</div>
          <div class="k spec wide" onclick="kbdKey('F2')">F2</div>
          <div class="k spec wide" onclick="kbdKey('F3')">F3</div>
          <div class="k spec wide" onclick="kbdKey('F4')">F4</div>
          <div class="k spec wide" onclick="kbdKey('F5')">F5</div>
          <div class="k spec wide" onclick="kbdKey('F6')">F6</div>
          <div class="k spec wide" onclick="kbdKey('F11')">F11</div>
          <div class="k spec wide" onclick="kbdKey('F12')">F12</div>
          <div class="k spec wide" onclick="kbdKey('PrintScreen')">PrtSc</div>
        </div>
        <!-- Number row -->
        <div class="kbd-row">
          <div class="k" onclick="kbdChar('`')">`</div>
          <div class="k" onclick="kbdChar('1')">1</div>
          <div class="k" onclick="kbdChar('2')">2</div>
          <div class="k" onclick="kbdChar('3')">3</div>
          <div class="k" onclick="kbdChar('4')">4</div>
          <div class="k" onclick="kbdChar('5')">5</div>
          <div class="k" onclick="kbdChar('6')">6</div>
          <div class="k" onclick="kbdChar('7')">7</div>
          <div class="k" onclick="kbdChar('8')">8</div>
          <div class="k" onclick="kbdChar('9')">9</div>
          <div class="k" onclick="kbdChar('0')">0</div>
          <div class="k" onclick="kbdChar('-')">-</div>
          <div class="k" onclick="kbdChar('=')">=</div>
          <div class="k spec xwide" onclick="kbdKey('Backspace')">‚å´ Del</div>
        </div>
        <!-- QWERTY row -->
        <div class="kbd-row">
          <div class="k spec wide" onclick="kbdKey('Tab')">Tab ‚á•</div>
          <div class="k" onclick="kbdChar('q')">q</div>
          <div class="k" onclick="kbdChar('w')">w</div>
          <div class="k" onclick="kbdChar('e')">e</div>
          <div class="k" onclick="kbdChar('r')">r</div>
          <div class="k" onclick="kbdChar('t')">t</div>
          <div class="k" onclick="kbdChar('y')">y</div>
          <div class="k" onclick="kbdChar('u')">u</div>
          <div class="k" onclick="kbdChar('i')">i</div>
          <div class="k" onclick="kbdChar('o')">o</div>
          <div class="k" onclick="kbdChar('p')">p</div>
          <div class="k" onclick="kbdChar('[')"> [</div>
          <div class="k" onclick="kbdChar(']')">]</div>
          <div class="k" onclick="kbdChar('\')">\</div>
        </div>
        <!-- ASDF row -->
        <div class="kbd-row">
          <div class="k spec xwide" onclick="kbdToggleMod('caps')" id="kCaps">Caps ‚á™</div>
          <div class="k" onclick="kbdChar('a')">a</div>
          <div class="k" onclick="kbdChar('s')">s</div>
          <div class="k" onclick="kbdChar('d')">d</div>
          <div class="k" onclick="kbdChar('f')">f</div>
          <div class="k" onclick="kbdChar('g')">g</div>
          <div class="k" onclick="kbdChar('h')">h</div>
          <div class="k" onclick="kbdChar('j')">j</div>
          <div class="k" onclick="kbdChar('k')">k</div>
          <div class="k" onclick="kbdChar('l')">l</div>
          <div class="k" onclick="kbdChar(';')">;</div>
          <div class="k" onclick="kbdChar('\'')">'</div>
          <div class="k spec xwide" onclick="kbdKey('Enter')">Enter ‚Üµ</div>
        </div>
        <!-- ZXCV row -->
        <div class="kbd-row">
          <div class="k spec xwide" onclick="kbdToggleMod('shift')" id="kShift">‚áß Shift</div>
          <div class="k" onclick="kbdChar('z')">z</div>
          <div class="k" onclick="kbdChar('x')">x</div>
          <div class="k" onclick="kbdChar('c')">c</div>
          <div class="k" onclick="kbdChar('v')">v</div>
          <div class="k" onclick="kbdChar('b')">b</div>
          <div class="k" onclick="kbdChar('n')">n</div>
          <div class="k" onclick="kbdChar('m')">m</div>
          <div class="k" onclick="kbdChar(','">,</div>
          <div class="k" onclick="kbdChar('.')">.</div>
          <div class="k" onclick="kbdChar('/')">/</div>
          <div class="k spec xwide" onclick="kbdKey('ArrowUp')">‚Üë</div>
        </div>
        <!-- Bottom row -->
        <div class="kbd-row">
          <div class="k spec wide" onclick="kbdToggleMod('ctrl')" id="kCtrl">Ctrl</div>
          <div class="k spec wide" onclick="kbdToggleMod('alt')" id="kAlt">Alt</div>
          <div class="k spec" style="min-width:200px" onclick="kbdChar(' ')">Space</div>
          <div class="k spec wide" onclick="kbdToggleMod('meta')" id="kMeta">‚äû Win</div>
          <div class="k spec wide" onclick="kbdKey('ArrowLeft')">‚Üê</div>
          <div class="k spec wide" onclick="kbdKey('ArrowDown')">‚Üì</div>
          <div class="k spec wide" onclick="kbdKey('ArrowRight')">‚Üí</div>
        </div>

        <!-- Special combos -->
        <div class="kbd-special-row">
          <button class="btn btn-g btn-sm" onclick="kbdCombo(['Control','c'])">Ctrl+C</button>
          <button class="btn btn-g btn-sm" onclick="kbdCombo(['Control','v'])">Ctrl+V</button>
          <button class="btn btn-g btn-sm" onclick="kbdCombo(['Control','x'])">Ctrl+X</button>
          <button class="btn btn-g btn-sm" onclick="kbdCombo(['Control','z'])">Ctrl+Z</button>
          <button class="btn btn-g btn-sm" onclick="kbdCombo(['Control','a'])">Ctrl+A</button>
          <button class="btn btn-g btn-sm" onclick="kbdCombo(['Control','s'])">Ctrl+S</button>
          <button class="btn btn-g btn-sm" onclick="kbdCombo(['Alt','F4'])">Alt+F4</button>
          <button class="btn btn-g btn-sm" onclick="kbdCombo(['Control','Alt','Delete'])">Ctrl+Alt+Del</button>
        </div>

        <div style="font-size:.72rem;color:var(--t2);font-family:'IBM Plex Mono',monospace;padding:8px;background:rgba(0,229,255,.04);border-radius:var(--rs);line-height:1.6;border:1px solid var(--b1)">
          üí° <strong>How it works:</strong> Keystrokes are sent over the P2P connection to the peer device.
          The peer sees the keys in real time. On the receiving end, keys are injected via a hidden input ‚Äî 
          click any focused text field on the peer's page first, then type here.
        </div>
      </div>
    </div>
  </div>

  <!-- SETTINGS -->
  <div class="panel" id="pg-settings">
    <div class="card">
      <div class="card-head"><div class="card-title"><span class="i">‚öôÔ∏è</span>Settings</div></div>
      <div class="settings-rows">
        <div class="sr">
          <div class="sr-info"><h4>Device Name</h4><p>How this device appears to peers</p></div>
          <input id="devNameInp" style="background:var(--s2);border:1px solid var(--b1);border-radius:var(--rs);padding:6px 12px;color:var(--t1);font-family:'IBM Plex Mono',monospace;font-size:.78rem;outline:none;width:180px" onchange="saveDevName()"/>
        </div>
        <div class="sr">
          <div class="sr-info"><h4>Clipboard Auto-Watch</h4><p>Watch for changes and auto-sync to connected device</p></div>
          <div class="tog" id="autoClipTog" onclick="toggleAutoClip()"></div>
        </div>
        <div class="sr">
          <div class="sr-info"><h4>Auto-Accept Files</h4><p>Automatically accept and download files from peer</p></div>
          <div class="tog on" id="autoFileTog" onclick="this.classList.toggle('on');saveSettings()"></div>
        </div>
        <div class="sr">
          <div class="sr-info"><h4>Desktop Notifications</h4><p>Show system notification when files or messages arrive</p></div>
          <button class="btn btn-g btn-sm" onclick="askNotifPerm()">Enable</button>
        </div>
        <div class="sr">
          <div class="sr-info"><h4>PeerJS Server</h4><p>Free hosted signaling ‚Äî no setup needed!</p></div>
          <span style="font-size:.72rem;color:var(--emerald);font-family:'IBM Plex Mono',monospace">0.peerjs.com ‚úì</span>
        </div>
        <div class="sr">
          <div class="sr-info"><h4>Install as App</h4><p>Add CrossConnect to your home screen ‚Äî works offline</p></div>
          <button class="btn btn-c btn-sm" id="pwaInstallBtn" onclick="pwaInstall()" style="display:none">üì≤ Install App</button>
          <button class="btn btn-g btn-sm" onclick="pwaInstall()">üì≤ Add to Home</button>
        </div>
        <div class="sr">
          <div class="sr-info"><h4>How to make it live</h4><p>Host on GitHub Pages ‚Äî upload index.html, enable Pages</p></div>
          <button class="btn btn-g btn-sm" onclick="window.open('https://pages.github.com','_blank')">GitHub Pages ‚Üó</button>
        </div>
        <div class="sr">
          <div class="sr-info"><h4>CrossConnect</h4><p>v2.0 ¬∑ 100% browser-based ¬∑ No server required</p></div>
          <span style="font-size:.72rem;color:var(--t2);font-family:'IBM Plex Mono',monospace">MIT License</span>
        </div>
      </div>
    </div>
  </div>

</main>
</div><!-- /app -->

<div class="overlay" id="overlay">
  <div class="spinner"></div>
  <p id="overlayMsg">Connecting...</p>
</div>

<div class="toasts" id="toastsEl"></div>

<script>
'use strict';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIG ‚Äî all stored locally, no server
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DEV_NAME = localStorage.getItem('cc_name') || ('Device-' + Math.random().toString(36).slice(2,6).toUpperCase());
const DEV_TYPE = /mobile|android|iphone|ipad/i.test(navigator.userAgent) ? 'üì± Mobile' : 'üíª Desktop';
let peer = null;       // PeerJS instance
let conn = null;       // DataConnection
let mediaConn = null;  // MediaConnection (screen share)
let screenStream = null;
let shareTimer = null;
let shareStart = null;
let annotActive = false;
let annotDrawing = false;
let annotCtx = null;
let micOn = true;
let autoClipTimer = null;
let lastClipText = '';
let clipHist = [];
let stats = { sent:0, recv:0, clips:0, bytes:0 };
let currentRoom = '';
const CHUNK = 64 * 1024; // 64KB per chunk
const receiving = {};  // fileId ‚Üí {meta, chunks, got}
let notifCount = 0;

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// PEER INIT (PeerJS ‚Äî free hosted signaling)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initPeer(peerId) {
  peer = new Peer(peerId, {
    // Uses PeerJS free cloud server at 0.peerjs.com ‚Äî NO backend needed!
    debug: 0,
    config: {
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' },
        // Free TURN for cross-network NAT traversal
        { urls: 'turn:openrelay.metered.ca:80', username:'openrelayproject', credential:'openrelayproject' },
        { urls: 'turn:openrelay.metered.ca:443', username:'openrelayproject', credential:'openrelayproject' }
      ]
    }
  });

  peer.on('open', (id) => {
    document.getElementById('myIdDisplay').textContent = 'ID: ' + id;
    toast('Ready', 'Enter a room code to connect to another device', 'info', '‚ö°');
  });

  // Someone connects to us
  peer.on('connection', (c) => {
    setupConn(c);
    toast('Incoming connection!', c.metadata?.name || 'A device', 'ok', 'üîó');
  });

  // Incoming media stream (screen share from remote)
  peer.on('call', (call) => {
    call.answer(); // Answer with no stream (we're just viewing)
    mediaConn = call;
    call.on('stream', (remoteStream) => {
      const vid = document.getElementById('screenVid');
      vid.srcObject = remoteStream;
      vid.style.display = 'block';
      document.getElementById('vpPh').style.display = 'none';
      document.getElementById('liveTag').classList.add('show');
      document.getElementById('viewport').classList.add('viewing');
      document.getElementById('ssStats').style.opacity = '1';
      document.getElementById('ssRes').textContent = 'Remote';
      document.getElementById('ssFps').textContent = 'Live';
      document.getElementById('ssLat').textContent = '~30ms';
      startShareTimer();
      toast('Screen stream received', 'Viewing remote screen live', 'ok', 'üñ•Ô∏è');
    });
  });

  peer.on('error', (err) => {
    hideOverlay();
    if (err.type === 'peer-unavailable') toast('Peer not found', 'Check the room code ‚Äî other device must connect first', 'warn', '‚ö†Ô∏è');
    else toast('Connection error', err.message, 'err', '‚ùå');
    setStatus('off');
  });
}

function connectRoom() {
  const room = document.getElementById('roomInp').value.trim().toUpperCase();
  if (room.length < 4) { toast('Too short', 'Enter at least 4 characters', 'warn', '‚ö†Ô∏è'); return; }
  currentRoom = room;
  setRoomCode(room); // keeps sidebar input, pair page, topbar, localStorage all in sync
  showOverlay('Connecting to room ' + room + '...');

  // Each device's PeerJS ID = roomCode + "-A" or "-B"
  // First one to join is A, second is B ‚Äî simple handshake
  const idA = 'cc-' + room + '-A';
  const idB = 'cc-' + room + '-B';

  setStatus('busy');
  // Try to be A first; if taken, be B and connect to A
  if (peer) { peer.destroy(); peer = null; conn = null; }

  initPeer(idA);

  peer.on('open', () => {
    // We got ID A ‚Äî wait for B to connect
    setPairStatus('Room ' + room + ' ready. Waiting for other device to join...');
    hideOverlay();
    setStatus('busy');
    toast('Room joined', 'Waiting for other device‚Ä¶', 'info', '‚è≥');
  });

  peer.on('error', (err) => {
    if (err.type === 'unavailable-id') {
      // ID A is taken ‚Äî we're device B, connect to A
      peer.destroy();
      initPeer(idB);
      peer.on('open', () => {
        hideOverlay();
        setPairStatus('Room ' + room + ' ‚Äî connecting to peer as device B...');
        const c = peer.connect(idA, { metadata:{ name: DEV_NAME, type: DEV_TYPE }, reliable: true });
        setupConn(c);
      });
    } else {
      hideOverlay();
      setStatus('off');
      toast('Error: ' + err.type, err.message, 'err', '‚ùå');
    }
  });
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// DATA CHANNEL PROTOCOL
// All messages: { t: type, ...data }
// Binary chunks go directly as ArrayBuffer
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setupConn(c) {
  conn = c;
  conn.on('open', () => {
    setStatus('on');
    hideOverlay();
    // Exchange device info
    dcSend({ t:'hello', name: DEV_NAME, type: DEV_TYPE });
    updateRtcBars(true);
    updateStorageRtcBar(true);
    updateKbdRtcBar(true);
    setPairStatus('‚úÖ Connected! P2P tunnel active.');
    addLog('‚ö°', 'P2P Connected', DEV_TYPE + ' ‚Üí WebRTC DataChannel');
    document.getElementById('peerBar').classList.add('show');
    document.getElementById('fileWarn').style.display = 'none';
    toast('P2P Connected! üéâ', 'Direct encrypted link to ' + (c.metadata?.name||'peer'), 'ok', '‚ö°');
    document.getElementById('dashInfo').textContent = '‚úÖ Connected';
    // Send shared store to peer on connect
    const myData = {};
    Object.entries(sharedStore).forEach(([k,v]) => { myData[k] = v.value; });
    dcSend({ t:'store-sync', data: myData });
    // If we have a folder open, send its tree to the newly connected peer
    if (rfbDirHandle) {
      rfbBuildTree(rfbDirHandle, rfbDirHandle.name).then(tree => {
        dcSend({ t:'rfb-tree', tree });
        toast('Folder shared with peer', rfbDirHandle.name, 'ok', 'üìÇ');
      });
    }
  });

  conn.on('data', (data) => {
    if (data instanceof ArrayBuffer) { handleBinary(data); return; }
    if (typeof data === 'object') { handleMsg(data); return; }
  });

  conn.on('close', () => {
    setStatus('off');
    updateRtcBars(false);
    updateStorageRtcBar(false);
    updateKbdRtcBar(false);
    document.getElementById('peerBar').classList.remove('show');
    document.getElementById('fileWarn').style.display = 'inline';
    document.getElementById('dashInfo').textContent = 'Disconnected';
    toast('Connection closed', 'Device disconnected', 'warn', 'üëã');
    conn = null;
  });

  conn.on('error', (e) => {
    toast('DataChannel error', e.message, 'err', '‚ùå');
    setStatus('off');
  });
}

function dcSend(obj) {
  if (conn?.open) conn.send(obj);
  else toast('Not connected', 'Pair a device first', 'warn', '‚ö†Ô∏è');
}

function handleMsg(msg) {
  switch(msg.t) {
    case 'hello':
      document.getElementById('peerNameEl').textContent = msg.name;
      document.getElementById('peerTypeEl').textContent = msg.type;
      toast('Device info received', msg.name + ' ¬∑ ' + msg.type, 'info', 'üì±');
      break;

    case 'clip':
      clipHist.unshift({ text: msg.text, dir: 'From device', time: nowStr() });
      renderClipHist();
      stats.clips++; updateStats();
      document.getElementById('clipTA').value = msg.text;
      // Also write to system clipboard if permitted
      navigator.clipboard.writeText(msg.text).catch(()=>{});
      addLog('üìã', 'Clipboard received', msg.text.slice(0,40));
      toast('Clipboard Sync', msg.text.slice(0,50), 'ok', 'üìã');
      if (Notification.permission === 'granted') new Notification('CrossConnect ‚Äî Clipboard', { body: msg.text.slice(0,100) });
      break;

    case 'notif':
      addNotif(msg.app, msg.title, msg.body, msg.icon||'üîî');
      break;

    case 'sms':
      addSmsContact(msg.from, msg.text, msg.number);
      break;

    case 'file-meta':
      receiving[msg.id] = { name:msg.name, size:msg.size, type:msg.type, chunks:[], got:0 };
      addFileItem(msg.id, msg.name, msg.size, 'in', 0);
      toast('Receiving: ' + msg.name, fmtBytes(msg.size), 'info', 'üì•');
      break;

    case 'file-done':
      finishReceive(msg.id);
      break;

    case 'req-screen':
      toast('Screen Request', 'Peer wants to view your screen', 'info', 'üñ•Ô∏è');
      if (confirm('Peer wants to view your screen. Share it?')) startShare();
      break;

    // ‚îÄ‚îÄ Remote File Browser messages ‚îÄ‚îÄ
    case 'rfb-tree':
      rfbReceiveTree(msg.tree);
      break;
    case 'rfb-req':
      rfbHandleRequest(msg);
      break;
    case 'rfb-refresh':
      if (rfbDirHandle) {
        rfbBuildTree(rfbDirHandle, rfbDirHandle.name).then(tree => {
          dcSend({ t:'rfb-tree', tree });
        });
      }
      break;
    case 'rfb-stop':
      rfbRemoteTree = null;
      document.getElementById('rfbBrowserArea').style.display = 'none';
      document.getElementById('rfbEmptyState').style.display = 'block';
      toast('Remote folder closed', 'Peer stopped sharing', 'warn', 'üìÅ');
      break;
    case 'rfb-err':
      toast('File Error', msg.err, 'err', '‚ùå');
      const rb = rfbPendingReqs[msg.reqId];
      if (rb) { rb.btn.disabled=false; rb.btn.textContent='‚¨á Get'; }
      break;

    case 'store-set':
      storageSet(msg.key, msg.value, true);
      toast('Storage Synced', msg.key + ' received from peer', 'info', 'üóÑÔ∏è');
      break;

    case 'store-del':
      storageDel(msg.key, false);
      break;

    case 'store-clear':
      sharedStore = {}; renderStorage();
      toast('Storage Cleared', 'Peer cleared shared storage', 'warn', 'üóë');
      break;

    case 'store-sync':
      // Merge peer's store into ours ‚Äî their data tagged as Remote
      // We also send our store back so they get our data too
      { const count = Object.keys(msg.data).length;
        Object.entries(msg.data).forEach(([k,v]) => storageSet(k, v, true));
        if (count > 0) toast('Storage Synced', count + ' entries merged from peer', 'ok', 'üóÑÔ∏è');
        // Send our store back to them (peer may not have our local entries)
        const myData = {};
        Object.entries(sharedStore).forEach(([k,v]) => { if (v.from !== 'Remote') myData[k] = v.value; });
        if (Object.keys(myData).length > 0) dcSend({ t:'store-sync', data: myData });
      }
      break;

    case 'kbd-char':
      kbdReceiveChar(msg.ch);
      break;
    case 'kbd-text':
      kbdReceiveText(msg.text);
      break;
    case 'kbd-key':
      { // Dispatch keyboard event to active element
        const el = document.activeElement;
        const count = msg.count || 1;
        for (let i=0; i<count; i++) {
          const ev = new KeyboardEvent('keydown', { key:msg.key, ctrlKey: msg.mods?.includes('Control'), altKey: msg.mods?.includes('Alt'), shiftKey: msg.mods?.includes('Shift'), metaKey: msg.mods?.includes('Meta'), bubbles:true });
          document.dispatchEvent(ev);
          if (el && (el.tagName==='INPUT'||el.tagName==='TEXTAREA')) {
            if (msg.key==='Backspace') { const s=el.selectionStart; if(s>0){el.value=el.value.slice(0,s-1)+el.value.slice(s); el.selectionStart=el.selectionEnd=s-1; el.dispatchEvent(new Event('input',{bubbles:true}));} }
            else if (msg.key==='Enter') { if(el.tagName==='TEXTAREA'){const s=el.selectionStart; el.value=el.value.slice(0,s)+'\n'+el.value.slice(s); el.selectionStart=el.selectionEnd=s+1; el.dispatchEvent(new Event('input',{bubbles:true}));} else el.form?.requestSubmit(); }
          }
        }
        addLog('‚å®Ô∏è', 'Remote key: ' + msg.key, msg.mods?.join('+') || '');
      }
      break;
    case 'kbd-combo':
      toast('Remote combo: ' + msg.keys.join('+'), '', 'info', '‚å®Ô∏è');
      break;
    case 'ping':
      dcSend({ t:'pong' });
      break;
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// FILE TRANSFER ‚Äî chunked ArrayBuffer
// Header format: [36B id][4B seq][data]
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function handleFiles(files) {
  if (!conn?.open) { toast('Not connected', 'Pair a device first!', 'warn', '‚ö†Ô∏è'); return; }
  Array.from(files).forEach(sendFile);
}

async function sendFile(file) {
  const id = 'f' + Date.now() + Math.random().toString(36).slice(2,6);
  addFileItem(id, file.name, file.size, 'out', 0);
  dcSend({ t:'file-meta', id, name:file.name, size:file.size, type:file.type });

  let offset = 0, seq = 0;
  while (offset < file.size) {
    // Simple flow control ‚Äî don't overflow the buffer
    while (conn.dataChannel && conn.dataChannel.bufferedAmount > 8*1024*1024) {
      await new Promise(r => setTimeout(r, 50));
    }
    const slice = file.slice(offset, offset + CHUNK);
    const ab = await slice.arrayBuffer();
    const pkt = new ArrayBuffer(40 + ab.byteLength);
    const dv = new DataView(pkt);
    const idPad = id.padEnd(36,' ').slice(0,36);
    for (let i=0;i<36;i++) dv.setUint8(i, idPad.charCodeAt(i));
    dv.setUint32(36, seq, true);
    new Uint8Array(pkt,40).set(new Uint8Array(ab));
    conn.send(pkt);
    offset += ab.byteLength;
    seq++;
    setFileProg(id, Math.round(offset/file.size*100));
  }
  dcSend({ t:'file-done', id });
  stats.sent++; stats.bytes += file.size; updateStats();
  addLog('üì§', file.name + ' sent', fmtBytes(file.size));
  toast('‚úÖ File sent', file.name, 'ok', 'üì§');
}

function handleBinary(ab) {
  const dv = new DataView(ab);
  const idBytes = new Uint8Array(ab, 0, 36);
  const id = String.fromCharCode(...idBytes).trimEnd();
  const seq = dv.getUint32(36, true);
  const chunk = ab.slice(40);
  const rf = receiving[id];
  if (!rf) return;
  rf.chunks[seq] = chunk;
  rf.got += chunk.byteLength;
  const pct = Math.min(99, Math.round(rf.got/rf.size*100));
  setFileProg(id, pct);
  // Also update rfb progress bar if applicable
  if (id.startsWith('rfb-')) {
    const reqId = id.slice(4);
    const req = rfbPendingReqs[reqId];
    if (req?.progEl) req.progEl.style.width = pct+'%';
  }
}

function finishReceive(id) {
  const rf = receiving[id];
  if (!rf) return;
  const blob = new Blob(rf.chunks, { type: rf.type||'application/octet-stream' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = rf.name; a.click();
  URL.revokeObjectURL(url);
  stats.recv++; stats.bytes += blob.size; updateStats();
  setFileProg(id, 100);
  addLog('üì•', rf.name + ' received', fmtBytes(blob.size));
  toast('‚úÖ Downloaded', rf.name + ' ¬∑ ' + fmtBytes(blob.size), 'ok', 'üì•');
  if (Notification.permission === 'granted') new Notification('CrossConnect ‚Äî File Received', { body: rf.name + ' (' + fmtBytes(blob.size) + ')' });
  // If this was an rfb file, update the button state
  if (id.startsWith('rfb-')) {
    const reqId = id.slice(4);
    const req = rfbPendingReqs[reqId];
    if (req) {
      req.btn.textContent = '‚úÖ Done';
      if (req.progEl) req.progEl.style.width = '100%';
      delete rfbPendingReqs[reqId];
    }
  }
  delete receiving[id];
}

function addFileItem(id, name, size, dir, pct) {
  const ext = (name.split('.').pop()||'?').toUpperCase().slice(0,4);
  const arrow = dir==='out'?'üì§':'üì•';
  const el = document.createElement('div');
  el.className = 'fi'; el.id = 'fi-'+id;
  el.innerHTML = `<div class="fi-ext">${ext}</div>
    <div class="fi-info">
      <div class="fi-name">${name}</div>
      <div class="fi-meta">${arrow} ${dir==='out'?'Sending':'Receiving'} ¬∑ ${fmtBytes(size)}</div>
      <div class="prog"><div class="prog-fill" id="fp-${id}" style="width:${pct}%"></div></div>
    </div>`;
  document.getElementById('fileList').prepend(el);
  document.getElementById('fileCount').textContent = document.getElementById('fileList').children.length;
}

function setFileProg(id, pct) {
  const bar = document.getElementById('fp-'+id);
  if (!bar) return;
  bar.style.width = pct+'%';
  if (pct >= 100) {
    bar.style.background = 'var(--emerald)';
    const fi = document.getElementById('fi-'+id);
    if (fi) fi.querySelector('.fi-meta').textContent = '‚úÖ Complete';
  }
}

function clearFiles() { document.getElementById('fileList').innerHTML=''; document.getElementById('fileCount').textContent='0'; }

// Drop zone
const dz = document.getElementById('dropZone');
dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('over'); });
dz.addEventListener('dragleave', () => dz.classList.remove('over'));
dz.addEventListener('drop', e => { e.preventDefault(); dz.classList.remove('over'); handleFiles(e.dataTransfer.files); });

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// CLIPBOARD
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function sendClip() {
  const text = document.getElementById('clipTA').value.trim();
  if (!text) return;
  if (!conn?.open) { toast('Not connected', 'Pair a device first', 'warn', '‚ö†Ô∏è'); return; }
  dcSend({ t:'clip', text });
  clipHist.unshift({ text, dir:'To device', time: nowStr() });
  renderClipHist();
  stats.clips++; updateStats();
  addLog('üìã', 'Clipboard sent', text.slice(0,40));
  toast('Clipboard Sent', text.slice(0,50), 'ok', 'üìã');
  document.getElementById('clipTA').value = '';
}

async function readSysClip() {
  try {
    const t = await navigator.clipboard.readText();
    document.getElementById('clipTA').value = t;
    toast('Clipboard read', 'Pasted from system clipboard', 'info', 'üìã');
  } catch { toast('Permission denied', 'Allow clipboard in browser', 'warn', '‚ö†Ô∏è'); }
}

function renderClipHist() {
  const el = document.getElementById('clipHistEl');
  el.innerHTML = clipHist.length === 0
    ? '<div style="text-align:center;padding:20px;color:var(--t2);font-size:.78rem;font-family:IBM Plex Mono,monospace">No clipboard history yet</div>'
    : clipHist.map(c => `
      <div class="ch" onclick="navigator.clipboard.writeText(${JSON.stringify(c.text)}).then(()=>toast('Copied!','','ok','üìã'))">
        <div class="ch-text">${c.text}</div>
        <div class="ch-meta"><span>${c.dir==='From device'?'üì±‚Üíüíª':'üíª‚Üíüì±'} ${c.dir}</span><span>${c.time}</span></div>
      </div>`).join('');
}

function toggleAutoClip() {
  const tog = document.getElementById('autoClipTog');
  tog.classList.toggle('on');
  saveSettings();
  if (tog.classList.contains('on')) {
    lastClipText = '';
    autoClipTimer = setInterval(async () => {
      try {
        const t = await navigator.clipboard.readText();
        if (t && t !== lastClipText && conn?.open) {
          lastClipText = t;
          document.getElementById('clipTA').value = t;
          sendClip();
        }
      } catch {}
    }, 1500);
    toast('Auto-Sync On', 'Watching clipboard every 1.5s', 'ok', 'üîÑ');
  } else {
    clearInterval(autoClipTimer);
    toast('Auto-Sync Off', '', 'info', '‚è∏');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SCREEN SHARE ‚Äî CROSS-DEVICE STRATEGY
// Desktop Chrome/Firefox/Edge: getDisplayMedia() natively
// Android/iOS: camera stream as fallback (OS blocks screen capture)
// Key insight: some Android Chrome versions define getDisplayMedia
// but throw TypeError when called ‚Äî so we NEVER pre-check, we just try.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const isMobileDevice = /android|iphone|ipad|ipod/i.test(navigator.userAgent);

function initScreenShareUI() {
  if (isMobileDevice) {
    const startBtn = document.getElementById('startShareBtn');
    startBtn.textContent = 'üì∑ Share Camera';
    startBtn.title = 'Screen capture is blocked on Android/iOS by the OS. Camera share offered instead.';
    document.getElementById('vpPh').innerHTML = `
      <div class="big">üì±</div>
      <h3>Camera Share Mode</h3>
      <p style="max-width:380px;line-height:1.7;font-family:'IBM Plex Mono',monospace;font-size:.76rem;color:var(--t2)">
        Android &amp; iOS block screen capture at the OS level ‚Äî no browser can bypass this.<br><br>
        <strong style="color:var(--cyan)">On this device:</strong> Tap <strong>"Share Camera"</strong> to stream your camera to the connected desktop.<br>
        <strong style="color:var(--emerald)">On desktop:</strong> Click <strong>"Share My Screen"</strong> and it will appear here live.
      </p>`;
  }
}

async function startShare() {
  // Reset placeholder first
  document.getElementById('vpPh').innerHTML = '<div class="big">‚è≥</div><h3>Opening picker‚Ä¶</h3><p>Please allow access when prompted</p>';

  try {
    if (isMobileDevice) {
      // ‚îÄ‚îÄ MOBILE: camera stream (screen capture is OS-blocked on Android/iOS) ‚îÄ‚îÄ
      screenStream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } },
        audio: document.getElementById('audioTog').classList.contains('on')
      });
    } else {
      // ‚îÄ‚îÄ DESKTOP: screen capture with camera fallback ‚îÄ‚îÄ
      try {
        // Attempt screen capture. Do NOT pre-check typeof ‚Äî some Android Chrome
        // versions define getDisplayMedia but throw when called. Let the try/catch decide.
        screenStream = await navigator.mediaDevices.getDisplayMedia({
          video: { frameRate: 30, width: { ideal: 1920 }, height: { ideal: 1080 } },
          audio: document.getElementById('audioTog').classList.contains('on')
        });
      } catch(inner) {
        if (inner.name === 'NotAllowedError' || inner.name === 'AbortError') {
          document.getElementById('vpPh').innerHTML = '<div class="big">üñ•Ô∏è</div><h3>No active session</h3><p>Share your screen or view the connected device</p>';
          return; // user cancelled ‚Äî silent exit
        }
        // getDisplayMedia truly unavailable ‚Äî fall back to camera
        console.warn('getDisplayMedia failed (' + inner.message + '), falling back to camera');
        screenStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        toast('Screen Capture Unavailable', 'Streaming camera instead. Requires Chrome/Firefox on HTTPS.', 'warn', 'üì∑');
      }
    }

    // ‚îÄ‚îÄ Show the stream in viewport ‚îÄ‚îÄ
    const vid = document.getElementById('screenVid');
    vid.srcObject = screenStream;
    vid.style.display = 'block';
    document.getElementById('vpPh').style.display = 'none';
    document.getElementById('liveTag').classList.add('show');
    document.getElementById('viewport').classList.add('sharing');
    document.getElementById('startShareBtn').style.display = 'none';
    document.getElementById('reqPhoneBtn').style.display = 'none';
    document.getElementById('stopShareBtn').style.display = 'inline-flex';
    document.getElementById('ssStats').style.opacity = '1';

    const s = screenStream.getVideoTracks()[0].getSettings();
    document.getElementById('ssRes').textContent = (s.width||'?') + '√ó' + (s.height||'?');
    document.getElementById('ssFps').textContent = Math.round(s.frameRate||30) + ' fps';
    document.getElementById('ssLat').textContent = conn?.open ? '~20ms' : 'Local preview';
    document.getElementById('roomShareLink').textContent = currentRoom
      ? location.href.split('?')[0] + '?room=' + currentRoom
      : 'Connect to a room to share link';

    startShareTimer();
    screenStream.getVideoTracks()[0].onended = stopShare;

    if (conn?.open) {
      mediaConn = peer.call(conn.peer, screenStream);
      toast(isMobileDevice ? 'üì∑ Camera Streaming!' : 'üñ•Ô∏è Screen Sharing!', 'Live stream to connected peer', 'ok', 'üñ•Ô∏è');
    } else {
      toast('Preview Active', 'Pair a device to stream to it', 'info', 'üì∑');
    }

  } catch(e) {
    document.getElementById('vpPh').innerHTML = '<div class="big">üñ•Ô∏è</div><h3>No active session</h3><p>Share your screen or view the connected device</p>';
    if (e.name === 'NotAllowedError' || e.name === 'AbortError') return;
    toast('Share Failed', e.message || 'Permission denied or not supported', 'err', '‚ùå');
    console.error('startShare:', e.name, e.message);
  }
}

function stopShare()

function stopShare() {
  if (screenStream) { screenStream.getTracks().forEach(t=>t.stop()); screenStream=null; }
  if (mediaConn) { mediaConn.close(); mediaConn=null; }
  clearInterval(shareTimer);
  const vid = document.getElementById('screenVid');
  vid.srcObject=null; vid.style.display='none';
  document.getElementById('vpPh').style.display='flex';
  document.getElementById('liveTag').classList.remove('show');
  document.getElementById('viewport').classList.remove('sharing','viewing');
  document.getElementById('startShareBtn').style.display='inline-flex';
  document.getElementById('reqPhoneBtn').style.display='inline-flex';
  document.getElementById('stopShareBtn').style.display='none';
  document.getElementById('ssStats').style.opacity='.3';
  ['ssRes','ssFps','ssLat'].forEach(id=>document.getElementById(id).textContent='‚Äî');
  document.getElementById('ssDur').textContent='00:00';
  document.getElementById('roomShareLink').textContent='Start sharing for a link';
  toast('Screen Share Stopped', '', 'info', '‚èπ');
}

function requestRemoteScreen() {
  if (!conn?.open) { toast('Not connected','','warn','‚ö†Ô∏è'); return; }
  dcSend({ t:'req-screen' });
  document.getElementById('vpPh').innerHTML='<div class="big">‚è≥</div><h3>Requesting screen...</h3><p>Waiting for peer to approve</p>';
  toast('Request sent', 'Waiting for peer to share screen', 'info', 'üì±');
}

function startShareTimer() {
  shareStart = Date.now();
  clearInterval(shareTimer);
  shareTimer = setInterval(() => {
    const s = Math.floor((Date.now()-shareStart)/1000);
    document.getElementById('ssDur').textContent = pad(Math.floor(s/60)) + ':' + pad(s%60);
  }, 1000);
}

function toggleAnnotate() {
  annotActive = !annotActive;
  const c = document.getElementById('annotCanvas');
  c.style.display = annotActive ? 'block' : 'none';
  document.getElementById('annotBtn').textContent = annotActive ? '‚úèÔ∏è Hide' : '‚úèÔ∏è Annotate';
  if (annotActive) {
    c.width = c.offsetWidth || 600; c.height = 200;
    annotCtx = c.getContext('2d');
    c.onmousedown = e => { annotDrawing=true; annotCtx.beginPath(); annotCtx.moveTo(e.offsetX,e.offsetY); };
    c.onmousemove = e => { if(!annotDrawing)return; annotCtx.strokeStyle='#00e5ff'; annotCtx.lineWidth=3; annotCtx.lineCap='round'; annotCtx.lineTo(e.offsetX,e.offsetY); annotCtx.stroke(); };
    c.onmouseup = c.onmouseleave = () => annotDrawing=false;
  }
}

function doScreenshot() {
  const vid = document.getElementById('screenVid');
  if (!screenStream && !vid.srcObject) { toast('No active stream','Start sharing first','warn','‚ö†Ô∏è'); return; }
  const c = document.createElement('canvas');
  c.width=vid.videoWidth||1920; c.height=vid.videoHeight||1080;
  c.getContext('2d').drawImage(vid,0,0);
  const a = document.createElement('a');
  a.href=c.toDataURL('image/png'); a.download='crossconnect-'+Date.now()+'.png'; a.click();
  toast('Screenshot saved!','PNG downloaded','ok','üì∏');
}

function toggleMic() {
  micOn = !micOn;
  document.getElementById('micBtn').textContent = micOn ? 'üé§ Mic On' : 'üîá Mic Off';
  if (screenStream) screenStream.getAudioTracks().forEach(t=>t.enabled=micOn);
}

function doFullscreen() {
  const vp = document.getElementById('viewport');
  if (!document.fullscreenElement) vp.requestFullscreen().catch(()=>{});
  else document.exitFullscreen();
}

function copyRoomLink() {
  const link = document.getElementById('roomShareLink').textContent;
  if (link.includes('Start')) { toast('Not sharing yet','Start a screen share first','warn','‚ö†Ô∏è'); return; }
  navigator.clipboard.writeText(link).then(()=>toast('Copied!','Share link copied','ok','üîó')).catch(()=>{});
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// NOTIFICATIONS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function askNotifPerm() {
  const r = await Notification.requestPermission();
  toast('Notifications', r==='granted'?'Enabled! ‚úÖ':'Denied by browser','ok','üîî');
}

function addNotif(app, title, body, icon) {
  notifCount++;
  document.getElementById('notifBadge').textContent = notifCount;
  document.getElementById('notifBadge').classList.add('show');
  const list = document.getElementById('notifList');
  if (list.querySelector('[data-empty]')) list.innerHTML='';
  const el = document.createElement('div');
  el.className='notif unread';
  el.innerHTML=`<div class="notif-app-ico">${icon}</div>
    <div class="notif-body">
      <div class="notif-hd"><span class="notif-app">${app}</span><span class="notif-t">just now</span></div>
      <div class="notif-title">${title}</div>
      <div class="notif-text">${body}</div>
      <div class="notif-acts">
        <button class="btn btn-g btn-sm" onclick="this.closest('.notif').remove();notifCount--;document.getElementById('notifBadge').textContent=notifCount">Dismiss</button>
      </div>
    </div>`;
  list.prepend(el);
  if (Notification.permission==='granted') new Notification(app+': '+title,{body});
  addLog(icon, title, body.slice(0,50));
}

function clearNotifs() {
  document.getElementById('notifList').innerHTML='<div data-empty style="text-align:center;padding:30px;color:var(--t2);font-family:IBM Plex Mono,monospace;font-size:.8rem">No notifications</div>';
  notifCount=0; document.getElementById('notifBadge').classList.remove('show');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// MESSAGES
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function addSmsContact(from, text, number) {
  const contacts = document.getElementById('contactsEl');
  if (contacts.querySelector('[data-empty]')) contacts.innerHTML='';
  let el = contacts.querySelector(`[data-num="${number}"]`);
  if (!el) {
    el = document.createElement('div');
    el.className='contact'; el.dataset.num=number;
    const colors=['#7c3aed,#3b82f6','#10b981,#0891b2','#f59e0b,#ef4444','#ec4899,#8b5cf6'];
    const col = colors[Math.floor(Math.random()*colors.length)];
    el.innerHTML=`<div class="av" style="background:linear-gradient(135deg,${col})">${from[0].toUpperCase()}</div>
      <div class="ci"><div class="cn">${from}</div><div class="cp">${text}</div></div>
      <div class="cu" style="display:none">1</div>`;
    el.onclick=()=>selectChat(el,from);
    contacts.appendChild(el);
  }
  el.querySelector('.cp').textContent=text;
  const badge=el.querySelector('.cu'); badge.style.display='grid'; badge.textContent=(parseInt(badge.textContent)||0)+1;
  toast('SMS from '+from, text.slice(0,50),'info','üí¨');
}

function selectChat(el,name) {
  document.querySelectorAll('.contact').forEach(c=>c.classList.remove('on'));
  el.classList.add('on');
  el.querySelector('.cu').style.display='none';
  document.getElementById('chatName').textContent=name;
  document.getElementById('chatAv').textContent=name[0].toUpperCase();
}

function sendMsg() {
  const inp=document.getElementById('chatInp');
  const text=inp.value.trim();
  if (!text) return;
  if (conn?.open) dcSend({t:'sms', from:DEV_NAME, text, number:DEV_NAME });
  const msgs=document.getElementById('chatMsgs');
  const t=nowStr();
  const el=document.createElement('div'); el.className='msg out';
  el.innerHTML=`<div class="mb">${text}</div><div class="mt">${t} ¬∑ Sent</div>`;
  msgs.appendChild(el); msgs.scrollTop=msgs.scrollHeight;
  inp.value='';
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// UI HELPERS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function go(page) {
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('on'));
  document.querySelectorAll('.nav').forEach(n=>n.classList.remove('on'));
  document.getElementById('pg-'+page)?.classList.add('on');
  document.querySelector(`[data-p="${page}"]`)?.classList.add('on');
}

function setStatus(state) {
  const led=document.getElementById('mainLed');
  const txt=document.getElementById('mainStatus');
  led.className='led';
  if (state==='on'){led.classList.add('on'); txt.textContent='Connected';}
  else if(state==='busy'){led.classList.add('busy'); txt.textContent='Connecting...';}
  else txt.textContent='Not Connected';
}

function updateRtcBars(on) {
  ['file','clip','screen'].forEach(id=>{
    const l=document.getElementById(id+'RtcLed');
    const t=document.getElementById(id+'RtcTxt');
    if(l) l.className='rtc-led'+(on?' on':'');
    if(t) t.textContent=on?'WebRTC DataChannel ACTIVE ¬∑ P2P ¬∑ DTLS Encrypted':'DataChannel ¬∑ Waiting';
  });
}

function addLog(ico, title, sub) {
  const list=document.getElementById('logList');
  if (list.querySelector('[data-empty]')) list.innerHTML='';
  const el=document.createElement('div'); el.className='log-item';
  el.innerHTML=`<div class="log-ico">${ico}</div>
    <div class="log-info">
      <div class="log-title">${title}</div>
      <div class="log-sub">${sub}</div>
    </div>
    <div class="log-time">${nowStr()}</div>`;
  list.prepend(el);
  if(list.children.length>25) list.lastChild.remove();
}

function updateStats() {
  document.getElementById('dSent').textContent=stats.sent;
  document.getElementById('dRecv').textContent=stats.recv;
  document.getElementById('dClip').textContent=stats.clips;
  document.getElementById('dBytes').textContent=fmtBytes(stats.bytes);
}

function setPairStatus(msg) {
  document.getElementById('pairStatusEl').textContent=msg;
}

function showOverlay(msg) {
  document.getElementById('overlayMsg').textContent=msg;
  document.getElementById('overlay').classList.add('show');
}
function hideOverlay() { document.getElementById('overlay').classList.remove('show'); }

function genCode() {
  const c='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  const code=Array.from({length:6},()=>c[Math.floor(Math.random()*c.length)]).join('');
  setRoomCode(code);
  return code;
}

// Central function ‚Äî always call this to update room code everywhere
function setRoomCode(code) {
  code = code.toUpperCase().replace(/[^A-Z0-9]/g,'');
  document.getElementById('roomInp').value = code;
  document.getElementById('topbarRoomInp').value = code;
  document.getElementById('pairCodeEl').textContent = code;
  localStorage.setItem('cc_room', code);
}

// Keep sidebar + topbar inputs in sync as user types
function syncRoomInputs(val) {
  val = val.toUpperCase().replace(/[^A-Z0-9]/g,'');
  document.getElementById('topbarRoomInp').value = val;
  document.getElementById('roomInp').value = val;
  document.getElementById('pairCodeEl').textContent = val || '‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî';
  if (val) localStorage.setItem('cc_room', val);
}

function copyTopbarCode() {
  const code = document.getElementById('topbarRoomInp').value.trim();
  if (!code) { toast('No Code','Enter or generate a room code first','warn','‚ö†Ô∏è'); return; }
  navigator.clipboard.writeText(code).then(() => toast('Copied!', 'Room code ' + code + ' copied', 'ok', 'üìã')).catch(()=>{});
}

function toast(title, body, type='info', icon='‚ÑπÔ∏è') {
  const el=document.getElementById('toastsEl');
  const div=document.createElement('div'); div.className='toast '+type;
  div.innerHTML=`<div class="toast-ico">${icon}</div><div><div class="toast-title">${title}</div>${body?`<div class="toast-body">${body}</div>`:''}</div>`;
  el.appendChild(div);
  setTimeout(()=>{ div.style.cssText='opacity:0;transform:translateX(60px);transition:all .3s'; setTimeout(()=>div.remove(),300); },3500);
}

function fmtBytes(b) {
  if(b<1024)return b+' B';
  if(b<1048576)return(b/1024).toFixed(1)+' KB';
  return(b/1048576).toFixed(1)+' MB';
}
function nowStr() { const d=new Date(); return pad(d.getHours())+':'+pad(d.getMinutes()); }
function pad(n) { return String(n).padStart(2,'0'); }

function saveDevName() { saveSettings(); }

function saveSettings() {
  // Device name
  const name = document.getElementById('devNameInp').value;
  if (name) localStorage.setItem('cc_name', name);
  // Toggle states
  localStorage.setItem('cc_autoFile', document.getElementById('autoFileTog').classList.contains('on') ? '1' : '0');
  localStorage.setItem('cc_autoClip', document.getElementById('autoClipTog').classList.contains('on') ? '1' : '0');
}

function loadSettings() {
  // Restore device name
  const name = localStorage.getItem('cc_name');
  if (name) document.getElementById('devNameInp').value = name;
  // Restore autoFileTog
  const autoFile = localStorage.getItem('cc_autoFile');
  if (autoFile === '0') document.getElementById('autoFileTog').classList.remove('on');
  else document.getElementById('autoFileTog').classList.add('on'); // default ON
  // Restore autoClipTog ‚Äî default OFF until manually enabled
  const autoClip = localStorage.getItem('cc_autoClip');
  if (autoClip === '1') {
    document.getElementById('autoClipTog').classList.add('on');
    // Re-start the auto-clip watcher silently
    lastClipText = '';
    autoClipTimer = setInterval(async () => {
      try {
        const t = await navigator.clipboard.readText();
        if (t && t !== lastClipText && conn?.open) { lastClipText = t; document.getElementById('clipTA').value = t; sendClip(); }
      } catch {}
    }, 1500);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// REMOTE FILE BROWSER
// Uses File System Access API (desktop Chrome/Edge) to
// share a real folder. Peer can browse & download files
// over the P2P data channel ‚Äî no server, fully direct.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let rfbDirHandle   = null;   // FileSystemDirectoryHandle on host
let rfbCurrentPath = [];     // Breadcrumb path on browser side
let rfbRemoteTree  = null;   // Folder tree received from host
let rfbPendingReqs = {};     // { reqId: {resolve, el} }

// ‚îÄ‚îÄ‚îÄ HOST: Share a folder ‚îÄ‚îÄ‚îÄ
async function shareFolder() {
  if (!window.showDirectoryPicker) {
    // On mobile/Firefox: fallback to picking individual files
    toast('Folder picker not available', 'Selecting individual files instead (Android/Firefox)', 'info', 'üìÇ');
    const input = document.createElement('input');
    input.type = 'file'; input.multiple = true;
    input.onchange = () => { if (input.files.length) rfbShareFileList(input.files); };
    input.click();
    return;
  }
  try {
    rfbDirHandle = await window.showDirectoryPicker({ mode: 'read' });
  } catch(e) {
    if (e.name === 'AbortError') return;
    toast('Error', e.message, 'err', '‚ùå'); return;
  }

  // Build file tree and broadcast to peer
  toast('Reading folder‚Ä¶', 'Building file list', 'info', 'üìÇ');
  const tree = await rfbBuildTree(rfbDirHandle, rfbDirHandle.name);

  document.getElementById('rfbFolderName').textContent = rfbDirHandle.name;
  const total = rfbCountFiles(tree);
  document.getElementById('rfbFileCount').textContent = total + ' file' + (total!==1?'s':'');
  document.getElementById('rfbHostArea').style.display = 'block';
  document.getElementById('rfbEmptyState').style.display = 'none';
  document.getElementById('shareFolderBtn').style.display = 'none';
  document.getElementById('stopFolderBtn').style.display = 'inline-flex';

  if (conn?.open) {
    dcSend({ t:'rfb-tree', tree });
    toast('Folder Shared!', rfbDirHandle.name + ' ‚Äî peer can now browse it', 'ok', 'üìÇ');
  } else {
    toast('Folder Ready', 'Connect a device to share it', 'info', 'üìÇ');
  }
}

async function rfbBuildTree(dirHandle, name) {
  const node = { name, type:'dir', children:[] };
  for await (const [n, h] of dirHandle.entries()) {
    if (h.kind === 'directory') {
      node.children.push(await rfbBuildTree(h, n));
    } else {
      const file = await h.getFile();
      node.children.push({ name: n, type:'file', size: file.size, mime: file.type });
    }
  }
  node.children.sort((a,b) => {
    if (a.type !== b.type) return a.type==='dir' ? -1 : 1;
    return a.name.localeCompare(b.name);
  });
  return node;
}

function rfbCountFiles(node) {
  if (node.type === 'file') return 1;
  return node.children.reduce((s,c) => s + rfbCountFiles(c), 0);
}

function stopFolderShare() {
  rfbDirHandle = null;
  document.getElementById('rfbHostArea').style.display = 'none';
  document.getElementById('rfbEmptyState').style.display = 'block';
  document.getElementById('shareFolderBtn').style.display = 'inline-flex';
  document.getElementById('stopFolderBtn').style.display = 'none';
  if (conn?.open) dcSend({ t:'rfb-stop' });
  toast('Folder sharing stopped', '', 'info', 'üìÅ');
}

// HOST: handle file request from peer
async function rfbHandleRequest(msg) {
  if (!rfbDirHandle) { dcSend({ t:'rfb-err', reqId: msg.reqId, err:'No folder shared' }); return; }
  try {
    let handle = rfbDirHandle;
    for (const seg of msg.path.slice(1)) { // skip root name
      handle = await handle.getDirectoryHandle ? await handle.getDirectoryHandle(seg).catch(()=>null) || await handle.getFileHandle(seg) : null;
      if (!handle) throw new Error('Path not found');
    }
    const file = await handle.getFile();
    // Send in chunks via existing file transfer protocol
    const id = 'rfb-' + msg.reqId;
    dcSend({ t:'file-meta', id, name: file.name, size: file.size, type: file.type });
    let offset=0, seq=0;
    while (offset < file.size) {
      while (conn.dataChannel && conn.dataChannel.bufferedAmount > 4*1024*1024)
        await new Promise(r=>setTimeout(r,50));
      const slice = file.slice(offset, offset+CHUNK);
      const ab = await slice.arrayBuffer();
      const pkt = new ArrayBuffer(40+ab.byteLength);
      const dv = new DataView(pkt);
      const idPad = id.padEnd(36,' ').slice(0,36);
      for(let i=0;i<36;i++) dv.setUint8(i, idPad.charCodeAt(i));
      dv.setUint32(36, seq, true);
      new Uint8Array(pkt,40).set(new Uint8Array(ab));
      conn.send(pkt);
      offset += ab.byteLength; seq++;
    }
    dcSend({ t:'file-done', id });
  } catch(e) {
    dcSend({ t:'rfb-err', reqId: msg.reqId, err: e.message });
  }
}

// ‚îÄ‚îÄ‚îÄ BROWSER: Receive tree and render ‚îÄ‚îÄ‚îÄ
function rfbReceiveTree(tree) {
  rfbRemoteTree = tree;
  rfbCurrentPath = [tree.name];
  document.getElementById('rfbRemoteName').textContent = tree.name;
  document.getElementById('rfbBrowserArea').style.display = 'block';
  document.getElementById('rfbEmptyState').style.display = 'none';
  const total = rfbCountFiles(tree);
  document.getElementById('rfbRemoteCount').textContent = '(' + total + ' files)';
  rfbRenderDir();
  go('storage');
  toast('Remote Folder Available!', tree.name + ' ‚Äî tap files to download', 'ok', 'üìÇ');
}

function rfbRenderDir() {
  let node = rfbRemoteTree;
  for (const seg of rfbCurrentPath.slice(1)) {
    node = node.children.find(c=>c.name===seg);
    if (!node) return;
  }

  // Breadcrumb
  const bc = document.getElementById('rfbFileList').parentNode;
  let bcEl = document.getElementById('rfbBreadcrumb');
  if (!bcEl) {
    bcEl = document.createElement('div');
    bcEl.id = 'rfbBreadcrumb'; bcEl.className = 'rfb-breadcrumb';
    bc.insertBefore(bcEl, document.getElementById('rfbFileList'));
  }
  bcEl.innerHTML = rfbCurrentPath.map((seg,i)=>{
    if (i === rfbCurrentPath.length-1) return `<span style="color:var(--t3)">${seg}</span>`;
    return `<span class="rfb-crumb" onclick="rfbNavTo(${i})">${seg}</span><span class="rfb-sep">/</span>`;
  }).join('');

  const list = document.getElementById('rfbFileList');
  list.innerHTML = '';

  // Back button
  if (rfbCurrentPath.length > 1) {
    const back = document.createElement('div');
    back.className = 'rfb-item folder';
    back.innerHTML = `<div class="rfb-ico">‚¨ÜÔ∏è</div><div class="rfb-info"><div class="rfb-name">.. (back)</div></div>`;
    back.onclick = () => { rfbCurrentPath.pop(); rfbRenderDir(); };
    list.appendChild(back);
  }

  node.children.forEach(child => {
    const el = document.createElement('div');
    el.className = 'rfb-item' + (child.type==='dir' ? ' folder' : '');
    const ico = child.type==='dir' ? 'üìÅ' : rfbFileIcon(child.name);
    if (child.type === 'dir') {
      el.innerHTML = `<div class="rfb-ico">${ico}</div>
        <div class="rfb-info"><div class="rfb-name">${child.name}</div>
        <div class="rfb-meta">${rfbCountFiles(child)} files</div></div>
        <span style="color:var(--t2);font-size:12px">‚Ä∫</span>`;
      el.onclick = () => { rfbCurrentPath.push(child.name); rfbRenderDir(); };
    } else {
      const reqId = 'r'+Date.now()+Math.random().toString(36).slice(2,5);
      el.innerHTML = `<div class="rfb-ico">${ico}</div>
        <div class="rfb-info">
          <div class="rfb-name">${child.name}</div>
          <div class="rfb-meta">${fmtBytes(child.size)}${child.mime?' ¬∑ '+child.mime.split('/')[0]:''}</div>
          <div class="rfb-prog" id="rfbp-${reqId}"><div class="rfb-prog-fill" id="rfbpf-${reqId}" style="width:0%"></div></div>
        </div>
        <button class="rfb-dl" id="rfbd-${reqId}" onclick="rfbRequestFile(${JSON.stringify([...rfbCurrentPath,child.name])},${JSON.stringify(reqId)},${JSON.stringify(child.name)},this)">‚¨á Get</button>`;
    }
    list.appendChild(el);
  });

  if (node.children.length === 0 && rfbCurrentPath.length > 1) {
    list.innerHTML += '<div style="padding:16px;text-align:center;color:var(--t2);font-size:.78rem;font-family:IBM Plex Mono,monospace">Empty folder</div>';
  }
}

function rfbNavTo(idx) {
  rfbCurrentPath = rfbCurrentPath.slice(0, idx+1);
  rfbRenderDir();
}

function rfbFileIcon(name) {
  const ext = name.split('.').pop().toLowerCase();
  const icons = {
    jpg:'üñºÔ∏è',jpeg:'üñºÔ∏è',png:'üñºÔ∏è',gif:'üñºÔ∏è',webp:'üñºÔ∏è',svg:'üñºÔ∏è',
    mp4:'üé¨',mov:'üé¨',avi:'üé¨',mkv:'üé¨',webm:'üé¨',
    mp3:'üéµ',wav:'üéµ',ogg:'üéµ',flac:'üéµ',aac:'üéµ',
    pdf:'üìÑ',doc:'üìù',docx:'üìù',xls:'üìä',xlsx:'üìä',ppt:'üìã',pptx:'üìã',
    zip:'üóúÔ∏è',rar:'üóúÔ∏è','7z':'üóúÔ∏è',tar:'üóúÔ∏è',gz:'üóúÔ∏è',
    js:'‚öôÔ∏è',ts:'‚öôÔ∏è',py:'üêç',html:'üåê',css:'üé®',json:'üì¶',
    txt:'üìÉ',md:'üìÉ',csv:'üìä',
  };
  return icons[ext] || 'üìÑ';
}

function rfbRequestFile(path, reqId, name, btn) {
  if (!conn?.open) { toast('Not connected','Pair device first','warn','‚ö†Ô∏è'); return; }
  btn.disabled = true; btn.textContent = '‚è≥';
  const prog = document.getElementById('rfbp-'+reqId);
  if (prog) prog.style.display = 'block';
  // Map reqId to file transfer id 'rfb-'+reqId
  receiving['rfb-'+reqId] = null; // placeholder so we can track progress
  rfbPendingReqs[reqId] = { name, btn, progEl: document.getElementById('rfbpf-'+reqId) };
  dcSend({ t:'rfb-req', reqId, path });
}

function rfbRefresh() {
  if (!conn?.open) { toast('Not connected','','warn','‚ö†Ô∏è'); return; }
  dcSend({ t:'rfb-refresh' });
  toast('Refreshing‚Ä¶','','info','üîÑ');
}

function rfbUpdateProgress(id, pct) {
  // id = 'rfb-XXXX', reqId = 'XXXX'
  const reqId = id.slice(4);
  const req = rfbPendingReqs[reqId];
  if (req?.progEl) req.progEl.style.width = pct+'%';
}

// Hook into existing finishReceive to handle rfb files
const _origFinishReceive = finishReceive;
// We'll patch finishReceive after definition

// Mobile fallback: share individual files when showDirectoryPicker unavailable
function rfbShareFileList(files) {
  const children = Array.from(files).map(f => ({ name: f.name, type: 'file', size: f.size, mime: f.type, _file: f }));
  const tree = { name: 'Shared Files', type: 'dir', children };
  // Store file handles for download
  window._rfbMobileFiles = {};
  children.forEach(ch => { window._rfbMobileFiles[ch.name] = ch._file; delete ch._file; });
  rfbDirHandle = 'mobile'; // sentinel
  document.getElementById('rfbFolderName').textContent = 'Shared Files (' + files.length + ')';
  document.getElementById('rfbFileCount').textContent = files.length + ' file(s)';
  document.getElementById('rfbHostArea').style.display = 'block';
  document.getElementById('rfbEmptyState').style.display = 'none';
  document.getElementById('shareFolderBtn').style.display = 'none';
  document.getElementById('stopFolderBtn').style.display = 'inline-flex';
  if (conn?.open) { dcSend({ t:'rfb-tree', tree }); toast('Files Shared!', files.length + ' files ‚Äî peer can download', 'ok', 'üìÇ'); }
  else toast('Files Ready', 'Connect a device to share them', 'info', 'üìÇ');
}

function rfbRefreshSelf() {
  if (rfbCurrentPath.length > 0 && rfbRemoteTree) rfbRenderDir();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// SHARED P2P STORAGE
// Bridges the gap: localStorage is device-local,
// so we maintain a synced in-memory map and push
// changes to the peer over the data channel.
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let sharedStore = {}; // { key: { value, from, time } }

function storageSet(keyOverride, valOverride, fromRemote) {
  const key   = keyOverride  || document.getElementById('storeKeyInp').value.trim();
  const value = valOverride  !== undefined ? valOverride : document.getElementById('storeValInp').value.trim();
  if (!key) { toast('Key required','Enter a key name','warn','‚ö†Ô∏è'); return; }
  const from  = fromRemote ? 'Remote' : 'Local';
  sharedStore[key] = { value, from, time: nowStr() };
  // Persist locally too
  try { localStorage.setItem('cc_store_' + key, JSON.stringify({ value, time: nowStr() })); } catch(e){}
  if (!fromRemote) {
    // Push to peer
    if (conn?.open) {
      dcSend({ t:'store-set', key, value });
    }
    document.getElementById('storeKeyInp').value = '';
    document.getElementById('storeValInp').value = '';
    toast('Stored & Synced', key + ' = ' + value.slice(0,30), 'ok', 'üóÑÔ∏è');
  }
  renderStorage();
}

function storageDel(key, broadcast) {
  delete sharedStore[key];
  try { localStorage.removeItem('cc_store_' + key); } catch(e){}
  if (broadcast && conn?.open) dcSend({ t:'store-del', key });
  renderStorage();
}

function storagePushAll() {
  if (!conn?.open) { toast('Not connected','Pair a device first','warn','‚ö†Ô∏è'); return; }
  Object.entries(sharedStore).forEach(([k,v]) => dcSend({ t:'store-set', key:k, value:v.value }));
  toast('Pushed', Object.keys(sharedStore).length + ' entries sent to peer', 'ok', 'üì°');
}

function storageClearAll() {
  if (!confirm('Clear all shared storage entries on this device?')) return;
  Object.keys(sharedStore).forEach(k => { try { localStorage.removeItem('cc_store_'+k); } catch(e){} });
  sharedStore = {};
  renderStorage();
  if (conn?.open) dcSend({ t:'store-clear' });
}

function storageLoadLocal() {
  // Reload any previously saved entries from localStorage
  for (let i=0; i<localStorage.length; i++) {
    const k = localStorage.key(i);
    if (k && k.startsWith('cc_store_')) {
      const realKey = k.slice(9);
      try {
        const parsed = JSON.parse(localStorage.getItem(k));
        sharedStore[realKey] = { value: parsed.value, from: 'Local', time: parsed.time || '' };
      } catch(e){}
    }
  }
  renderStorage();
}

function renderStorage() {
  const el = document.getElementById('storageEntries');
  const keys = Object.keys(sharedStore);
  if (keys.length === 0) {
    el.innerHTML = '<div data-empty style="text-align:center;padding:24px;color:var(--t2);font-size:.8rem;font-family:IBM Plex Mono,monospace">No entries yet. Set a key-value pair above.</div>';
    return;
  }
  el.innerHTML = keys.map(k => {
    const e = sharedStore[k];
    const srcColor = e.from === 'Remote' ? 'var(--violet)' : 'var(--emerald)';
    return `<div class="se">
      <div class="se-key">${k}</div>
      <div class="se-val">${e.value}</div>
      <div class="se-src" style="color:${srcColor}">${e.from==='Remote'?'üì±':'üíª'}<span>${e.from}</span></div>
      <button class="se-del" onclick="storageDel(${JSON.stringify(k)},true)" title="Delete">‚úï</button>
    </div>`;
  }).join('');
}

function updateStorageRtcBar(on) {
  const l = document.getElementById('storeRtcLed');
  const t = document.getElementById('storeRtcTxt');
  if(l) l.className='rtc-led'+(on?' on':'');
  if(t) t.textContent = on ? 'Shared Storage ¬∑ P2P Sync Active' : 'Shared Storage ¬∑ Connect a device to sync';
}



// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// REMOTE KEYBOARD
// Sends key events over P2P. Peer receives 
// them and replays into a hidden input so
// the active element on their page gets input.
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let kbdBuffer = '';
let kbdMods = { shift:false, ctrl:false, alt:false, meta:false, caps:false };

function kbdChar(ch) {
  let out = ch;
  if (kbdMods.shift || kbdMods.caps) {
    const SHIFT_MAP = {'`':'~','1':'!','2':'@','3':'#','4':'$','5':'%','6':'^','7':'&','8':'*','9':'(','0':')','-':'_','=':'+','[':'{',']':'}','\\':'|',';':':','\'':'"',',':'<','.':'>','/':'?',' ':' '};
    if (SHIFT_MAP[ch]) out = SHIFT_MAP[ch];
    else if (ch.length === 1 && ch >= 'a' && ch <= 'z') out = ch.toUpperCase();
    if (kbdMods.shift) { kbdMods.shift = false; document.getElementById('kShift')?.classList.remove('active-mod'); }
  }
  kbdBuffer += out;
  kbdUpdateDisplay();
  // Send char immediately
  if (conn?.open) dcSend({ t:'kbd-char', ch: out });
  else toast('Not connected', 'Pair a device to type remotely', 'warn', '‚å®Ô∏è');
}

function kbdKey(key) {
  // Build modifier combo
  const mods = [];
  if (kbdMods.ctrl) { mods.push('Control'); kbdMods.ctrl=false; document.getElementById('kCtrl')?.classList.remove('active-mod'); }
  if (kbdMods.alt)  { mods.push('Alt');     kbdMods.alt=false;  document.getElementById('kAlt')?.classList.remove('active-mod'); }
  if (kbdMods.meta) { mods.push('Meta');    kbdMods.meta=false; document.getElementById('kMeta')?.classList.remove('active-mod'); }
  if (kbdMods.shift){ mods.push('Shift');   kbdMods.shift=false;document.getElementById('kShift')?.classList.remove('active-mod');}

  if (key === 'Backspace') { kbdBuffer = kbdBuffer.slice(0,-1); kbdUpdateDisplay(); }
  else if (key === 'Enter') { kbdBuffer += '‚Üµ\n'; kbdUpdateDisplay(); }

  if (conn?.open) dcSend({ t:'kbd-key', key, mods });
  else toast('Not connected', 'Pair a device to type remotely', 'warn', '‚å®Ô∏è');
}

function kbdCombo(keys) {
  if (conn?.open) dcSend({ t:'kbd-combo', keys });
  else toast('Not connected','','warn','‚å®Ô∏è');
  toast('Sent', keys.join('+'), 'ok', '‚å®Ô∏è');
}

function kbdToggleMod(mod) {
  kbdMods[mod] = !kbdMods[mod];
  const idMap = { shift:'kShift', ctrl:'kCtrl', alt:'kAlt', meta:'kMeta', caps:'kCaps' };
  document.getElementById(idMap[mod])?.classList.toggle('active-mod', kbdMods[mod]);
}

function kbdUpdateDisplay() {
  const el = document.getElementById('kbdText');
  if (el) el.textContent = kbdBuffer.slice(-60); // Show last 60 chars
}

let kbdLastFree = '';
function kbdFreeType(val) {
  // Diff: find new chars added
  if (val.length > kbdLastFree.length) {
    const added = val.slice(kbdLastFree.length);
    kbdBuffer += added;
    kbdUpdateDisplay();
    if (conn?.open) dcSend({ t:'kbd-text', text: added });
  } else if (val.length < kbdLastFree.length) {
    // Backspace pressed
    const n = kbdLastFree.length - val.length;
    kbdBuffer = kbdBuffer.slice(0, -n);
    kbdUpdateDisplay();
    if (conn?.open) dcSend({ t:'kbd-key', key:'Backspace', mods:[], count:n });
  }
  kbdLastFree = val;
}

function kbdFreeKey(e) {
  if (e.key === 'Enter') {
    e.preventDefault();
    kbdKey('Enter');
    document.getElementById('kbdFreeInp').value = '';
    kbdLastFree = '';
  }
}

function kbdSendAll() {
  const text = kbdBuffer.replace(/‚Üµ\n/g,'\n');
  if (!text.trim()) { toast('Nothing typed','Type something first','warn','‚å®Ô∏è'); return; }
  if (conn?.open) {
    dcSend({ t:'kbd-text', text });
    toast('Sent!', text.slice(0,40), 'ok', '‚å®Ô∏è');
  } else toast('Not connected','Pair a device first','warn','‚å®Ô∏è');
}

function kbdClear() {
  kbdBuffer = '';
  kbdUpdateDisplay();
  document.getElementById('kbdFreeInp').value = '';
  kbdLastFree = '';
}

// RECEIVER SIDE ‚Äî inject keystrokes into active element
function kbdReceiveChar(ch) {
  const el = document.activeElement;
  if (el && (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA')) {
    const s = el.selectionStart || el.value.length;
    el.value = el.value.slice(0,s) + ch + el.value.slice(s);
    el.selectionStart = el.selectionEnd = s + 1;
    el.dispatchEvent(new Event('input', {bubbles:true}));
  }
  addLog('‚å®Ô∏è', 'Remote key: ' + (ch === ' ' ? 'Space' : ch), 'from peer');
}

function kbdReceiveText(text) {
  const el = document.activeElement;
  if (el && (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA')) {
    const s = el.selectionStart || el.value.length;
    el.value = el.value.slice(0,s) + text + el.value.slice(s);
    el.selectionStart = el.selectionEnd = s + text.length;
    el.dispatchEvent(new Event('input', {bubbles:true}));
  }
  // Also show in clipboard area for convenience
  const ta = document.getElementById('clipTA');
  if (ta && document.activeElement !== ta) {
    ta.value += text;
  }
  toast('Remote typing', text.slice(0,30), 'info', '‚å®Ô∏è');
}

function updateKbdRtcBar(on) {
  const l = document.getElementById('kbdRtcLed');
  const t = document.getElementById('kbdRtcTxt');
  if(l) l.className='rtc-led'+(on?' on':'');
  if(t) t.textContent = on ? 'Remote Keyboard ¬∑ P2P Active ‚Äî type here to type on peer' : 'Remote Keyboard ¬∑ Connect a device to type remotely';
}

function init() {
  // ‚úÖ Restore ALL settings from localStorage
  loadSettings();

  // ‚úÖ Restore room code ‚Äî never generate a new one on refresh
  const params = new URLSearchParams(location.search);
  const urlRoom = params.get('room');
  const savedRoom = localStorage.getItem('cc_room');
  const roomToUse = urlRoom ? urlRoom.toUpperCase() : savedRoom;
  if (roomToUse) {
    setRoomCode(roomToUse);
  } else {
    genCode(); // Only if truly first ever launch
  }

  renderClipHist();
  updateRtcBars(false);
  storageLoadLocal(); // Reload persisted shared storage entries

  // ‚îÄ‚îÄ‚îÄ PWA: inject proper manifest with SVG icon ‚îÄ‚îÄ‚îÄ
  // Browsers need a real icon (not emoji) to show "Add to Home Screen" prompt
  const iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
    <rect width="512" height="512" rx="96" fill="#060810"/>
    <rect width="512" height="512" rx="96" fill="url(#g)"/>
    <defs>
      <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0%" stop-color="#00e5ff" stop-opacity=".9"/>
        <stop offset="100%" stop-color="#8b5cf6" stop-opacity=".9"/>
      </linearGradient>
    </defs>
    <text x="256" y="340" font-size="280" text-anchor="middle" fill="white">‚ö°</text>
  </svg>`;
  const iconUrl = 'data:image/svg+xml,' + encodeURIComponent(iconSvg);
  
  const manifest = {
    name: 'CrossConnect',
    short_name: 'CrossConnect',
    description: 'P2P file, clipboard, screen & keyboard sharing ‚Äî no server needed',
    start_url: location.href,
    display: 'standalone',
    orientation: 'any',
    background_color: '#060810',
    theme_color: '#00e5ff',
    icons: [
      { src: iconUrl, sizes: '192x192', type: 'image/svg+xml', purpose: 'any maskable' },
      { src: iconUrl, sizes: '512x512', type: 'image/svg+xml', purpose: 'any maskable' }
    ],
    shortcuts: [
      { name: 'Files', url: location.href + '?goto=files', icons: [{ src: iconUrl, sizes: '96x96' }] },
      { name: 'Clipboard', url: location.href + '?goto=clipboard', icons: [{ src: iconUrl, sizes: '96x96' }] }
    ]
  };
  const mBlob = new Blob([JSON.stringify(manifest)], { type:'application/manifest+json' });
  const mUrl  = URL.createObjectURL(mBlob);
  document.getElementById('pwaManifest').href = mUrl;
  document.getElementById('appleIcon').href   = iconUrl;

  // ‚îÄ‚îÄ‚îÄ Service Worker: full offline cache ‚îÄ‚îÄ‚îÄ
  if ('serviceWorker' in navigator) {
    const sw = `
const CACHE = 'cc-v3';
const URLS  = ['${location.href}',
  'https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js',
  'https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500;600;700&family=Outfit:wght@300;400;600;700;800;900&display=swap'];
self.addEventListener('install', e => {
  self.skipWaiting();
  e.waitUntil(caches.open(CACHE).then(c => c.addAll(URLS).catch(()=>{})));
});
self.addEventListener('activate', e => {
  e.waitUntil(caches.keys().then(ks => Promise.all(ks.filter(k=>k!==CACHE).map(k=>caches.delete(k)))));
  self.clients.claim();
});
self.addEventListener('fetch', e => {
  e.respondWith(caches.match(e.request).then(r => r || fetch(e.request).then(res => {
    if (res.ok && e.request.url.startsWith('http')) {
      const clone = res.clone();
      caches.open(CACHE).then(c => c.put(e.request, clone));
    }
    return res;
  }).catch(() => caches.match('${location.href}'))));
});`;
    const swBlob = new Blob([sw], {type:'text/javascript'});
    navigator.serviceWorker.register(URL.createObjectURL(swBlob)).catch(()=>{});
  }

  // ‚îÄ‚îÄ‚îÄ PWA Install prompt ‚îÄ‚îÄ‚îÄ
  let deferredInstall = null;
  window.addEventListener('beforeinstallprompt', e => {
    e.preventDefault();
    deferredInstall = e;
    // Show install button in settings
    const btn = document.getElementById('pwaInstallBtn');
    if (btn) btn.style.display = 'inline-flex';
    toast('Install App', 'CrossConnect can be installed ‚Äî go to Settings!', 'info', 'üì≤');
  });
  window.pwaInstall = async () => {
    if (deferredInstall) {
      deferredInstall.prompt();
      const { outcome } = await deferredInstall.userChoice;
      deferredInstall = null;
      if (outcome === 'accepted') toast('Installed!', 'CrossConnect added to your home screen', 'ok', 'üì≤');
    } else {
      toast('Install via Browser', 'Tap the browser menu ‚Üí "Add to Home Screen" or "Install App"', 'info', 'üì≤');
    }
  };

  initScreenShareUI(); // Set up screen share UI based on device type
  toast('CrossConnect Ready', 'Your room code is shown in the top bar ‚Äî share it to connect!', 'info', '‚ö°');
}

init();
</script>
</body>
</html>
